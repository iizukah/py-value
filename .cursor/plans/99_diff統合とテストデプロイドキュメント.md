# 99_diff 統合・テスト・デプロイ・ドキュメント整備 実施計画

## 確認済み回答（プラン反映）

| # | 項目 | 回答 |
|---|------|------|
| 1 | 統合 99_diff のファイル名の日付 | **実行日の日付**を使う（実行時に自動で 01_YYYY-MM-DD.md） |
| 2 | 既存 99_diff のアーカイブ先 | **docs/01_specs/99_diff/archive/** |
| 3 | 新規要件 ID（追加仕様） | **新規用ブロック**（例: FR-P050 以降を追加用） |
| 4 | 枠組みがプラグイン仕様に依存している場合 | **ストップして報告書のみ作成**（プラン継続しない） |
| 5 | テスト仕様書（TEST-01）の改訂方法 | **既存の末尾に新規・変更分を追記** |
| 6 | 仕様と比較する実装の範囲 | **枠組み＋プラグインの全体** |
| 7 | 本番デプロイ | **実行する**（マニュアルに従いデプロイを実行） |
| 8 | 本番環境での E2E | **npm run test:e2e:prod 等のスクリプトを実行** |
| 9 | プロジェクト README の主言語 | **日本語** |
| 10 | セキュリティ（npm audit で脆弱性あり） | **破壊的でない範囲で npm audit fix を実行し、結果を報告** |

---

## 前提・スコープ

- **仕様書の置き場所**: docs/01_specs（01_requirements, 02_architecture, 03_contracts, 04_ui_ux, 05_test, 06_operations, 99_diff）
- **99_diff 既存ファイル**: 0001～0009（ワイヤーフレーム、採点結果TODO、mock 組み込み、一貫性チェック、レビュー指摘、WCAG、デザイン、CD 一覧、DD 細部差分）
- **統合後のファイル名**: `01_YYYY-MM-DD.md`（**実行日の日付**。実行時に自動）
- **アーカイブ先**: **docs/01_specs/99_diff/archive/**（既存 99_diff ファイルを統合後に移動）

---

## Phase 1: 仕様 vs 実装の比較と 99_diff 統合

### 1.1 仕様と実装の差分整理

- docs/01_specs の確定仕様（REQ-01, REQ-02, ARC-*, DATA-*, API-*, UX-*, CD/DD 系）と、**枠組み＋プラグインの全体**の現行実装（src）を比較する。
- 既存 99_diff（0001～0009）の内容を読み、**既存仕様書と一致するか／実装と一致するか**で分類する。
  - **追加仕様**: 仕様書に存在せず実装されているもの → 新規 ID を発行し「追加仕様」と明示。新規要件は **FR-P050 以降のブロック**で発行。
  - **変更仕様**: 仕様書と異なるが実装と合致するもの → 「変更仕様」と明示し、対応する既存 ID に紐づける。
  - **削除**: 仕様書と異なり実装とも合致しないもの → 一覧から削除する。

### 1.2 ID の振り直し方針

- **要件（枠）**: FR-Fxxx（REQ-01）。新規要件は連番で発行。
- **要件（プラグイン）**: FR-Pxxx（REQ-02）。**新規は FR-P050 以降のブロック**で発行（追加仕様の ID を併記）。
- **詳細差分（DD）**: DD-001～ を継続。今回のワークスペース UI・セル Run（Jupyter 相当）・Monaco 等は新規 DD または既存 DD の「変更仕様」として扱う。
- **デザイン（CD）**: CD-001～ を継続。未反映・変更分は「変更仕様」または追加で記載。

### 1.3 1 ファイルへの統合

- 上記分類・ID を反映した **単一の 99_diff ファイル** を作成する。
- **ファイル名**: docs/01_specs/99_diff/01_YYYY-MM-DD.md（**実行日の日付**）
- 構成: 目的・日付 → 枠組み関連の差分（要件・CD） → プラグイン関連の差分（要件・DD・CD） → ID 対応表 → 関連ドキュメント参照。

### 1.4 既存 99_diff のアーカイブ

- **docs/01_specs/99_diff/archive** が無ければ作成する。
- 0001～0009 の 9 ファイルを **docs/01_specs/99_diff/archive/** に移動する（統合後）。

---

## Phase 2: 枠組みとプラグインの依存チェック

- **確認内容**: 枠組みの仕様（REQ-01, ARC-01, 契約）が、プラグイン固有の仕様（REQ-02, ARC-02, DATA-02, UX-03）に**依存していないか**を確認する。
- **判定**: 依存していない → プラン継続。**依存している場合 → プランをストップし、報告書を docs/99_history に作成する。実行はここで終了。**

---

## Phase 3: 既存仕様書との矛盾チェック

- 統合した 99_diff の各項目について、REQ-01, REQ-02, DATA-02, UX-03 等と照合する。
- 矛盾がある場合: 実装に合わせるなら「変更仕様」として 99_diff に明記。実装も仕様も不要なら 99_diff から削除。

---

## Phase 4: テスト仕様書の改訂

- **対象**: docs/01_specs/05_test/TEST-01_test_plan.md（および必要に応じ TEST-02）
- **手順**:
  1. 統合した 99_diff の新規・変更 ID を反映し、**既存の末尾に**単体・結合・E2E のテストケースを**追記**する。
  2. **変更履歴**をテスト仕様書の文末等に追記（日付・変更内容・関連 ID）。
  3. 単体: TC-xxx, TC-Pxx を必要に応じて追加。
  4. 結合: TC-INT-xx を追記。
  5. E2E: TC-E2E-xx を追記。
  6. 各テストケースに適切なテストケース ID を振る。

---

## Phase 5: コードへの ID 埋め込み

- 新規発行・変更した仕様 ID（DD-xxx, FR-P0xx, CD-xxx 等）を、対応する実装箇所のコメントとして埋め込む。主な対象: index.tsx, MonacoCodeCell.tsx, CodeInputWithHighlight.tsx 等。

---

## Phase 6: 開発環境でのテスト実行

- 単体: npm run test（Vitest）
- 結合: 定義に従い実行
- E2E: npm run test:e2e（Playwright）

---

## Phase 7: 本番デプロイ

- docs/02_manuals/02_デプロイマニュアル.md および INFRA-01 に従い、**本番環境へデプロイを実行**する。

---

## Phase 8: 本番環境での E2E テスト

- **npm run test:e2e:prod** 等のスクリプトを実行する。結果を記録する。

---

## Phase 9: 02_manuals の清書と追加

### 9.1 清書

- 01_環境構築マニュアル.md と 02_デプロイマニュアル.md を、人間が読みやすいように見出し・文体・手順を整える。

### 9.2 追加マニュアル 1: プラグインを追加する方法・仕様

- REQ-01 のプラグイン契約、ARC-01/02、レジストリ登録方法を参照し、手順・型・登録コード例・判定アダプタの形を記載したドキュメントを 02_manuals に追加する。

### 9.3 追加マニュアル 2: 今回のプラグイン問題の概要・仕様と Cursor プロンプト例

- データ分析プラグインで扱った問題（HTML 混入、Monaco、セル Run Jupyter 相当、右ペイン表記等）の概要・仕様と、「Cursor に問題を指示する場合のプロンプト例」を 02_manuals に追加する。

---

## Phase 10: セキュリティ確認と .gitignore

- **セキュリティ**: npm audit、環境変数・シークレットの露出、サニタイズ、認証・認可をチェック。**脆弱性があった場合は破壊的でない範囲で npm audit fix を実行し、結果を報告する。**
- **.gitignore**: .env、ビルド成果物、機密になり得るパスが適切に無視されているか確認。不足があれば追記。

---

## Phase 11: プロジェクト全体の README.md

- リポジトリルートに README.md を新規作成または全面改訂する。**主言語は日本語。** プロジェクト名・目的、技術スタック、ディレクトリ構成、開発の始め方、テスト、デプロイ概要、仕様書・マニュアルの場所、貢献・トレーサビリティへの言及を含める。

---

## Phase 12: 報告書の作成とコミット

- Phase 1～11 の実施内容・結果をまとめた報告書を docs/99_history に作成する（連番）。
- Conventional Commits に従い、日本語メッセージの場合は -F で UTF-8 ファイルを指定してコミットする。

---

## 実施順序

Phase 1 → 2（依存ならストップ・報告）→ 3 → 4 → 5 → 6 → 7 → 8 → 9 → 10 → 11 → 12。
