# 細部修正プラン（反映済み）

## 概要

仕様書と実装の差分を 99_diff に ID 付きでまとめた上で、パンくず・履歴一覧・ワークスペース Retry・下書き UX・コード欄 mock 準拠・管理画面メッセージ削除を修正する。仕様からの差分は 99_diff に ID を振って記録する。最後に単体・結合・E2E テストを実行し、報告書作成とコミットを行う。

## 前提・準拠

- **.cursor**: AGENTS.md に基づく。仕様正本は docs/01_specs。差分は docs/01_specs/99_diff に ID 付きで記録。トレーサビリティ・TDD・99_history・コミットは .cursor/rules に従う。docs/.drafts は Writer 時以外参照しない（ただしユーザー指示で pyvalue5.html をセルイメージの参考として参照可）。
- **ワークスペース**: アプリの最重要ポイント。デザインは mock.html を踏襲。採点に関する個所は現行仕様のまま。セルのイメージは docs/.drafts/pyvalue5.html も参考にするが、**デザインは mock.html 優先**。
- **変更管理 ID**: 仕様と実装の細部差分には **DD-001, DD-002, ...**（Detail Diff）を 99_diff で付与。
- **DRAFT 関連 ID**: 既存の続き（FR-F0xx, API-021 等、テストは TEST-01 に追記）。要件 ID・API ID・テスト ID を一貫して割り振り、テスト仕様書・テスト実装も行う。

## 確定した方針（質問回答）

- **履歴一覧の問題タイトル**: クライアントで問題一覧を取得して questionId → title マップで表示（API 変更なし）。
- **下書きの有無**: 新規 API（GET /api/workbooks/{workbookId}/drafts?X-Client-Id）を追加し、下書きがある questionId 一覧を返す。
- **セル単位 Run**: セル単位の Run を実装し、実行結果を Variable Watcher に表示する。加えて、実行結果をそのセルの下にも表示する。

---

## Phase 0: 仕様書と実装の差分を 99_diff にまとめる（ID 付き）

**成果物**: `docs/01_specs/99_diff/0009_仕様と実装_細部差分_DD.md` を新規作成する。

- 既存の 0001～0008 を踏まえ、現時点で残っている仕様書との差分・未反映・曖昧な点を一覧化する。
- 各項目に **DD-001 ～ DD-xxx** を 1 対 1 で割り振り、「仕様上の扱い」「現行実装」「方針」を簡潔に書く。
- 本プランで対応する項目のうち仕様に明記がないものはここに DD-xxx として列挙する（パンくずのアイコン・中央寄せ、履歴一覧の問題タイトル、下書き一覧 API・導線、ワークスペース Retry 挙動、セル追加/削除/実行・セル下に実行結果、管理画面「保存しました」削除など）。
- 参照: docs/01_specs/04_ui_ux/reference/mock.html、API-01、DATA-01、0008_Webデザイン変更一覧_CD.md。

---

## Phase 1: パンくずリストの調整とアイコン

**対象**: src/app/components/layout/Breadcrumb.tsx、src/lib/breadcrumb.ts。

- **左寄せすぎ**: パンくずを main-content やコンテンツ幅に合わせて中央寄せ（例: max-width: 1200px; margin: 0 auto）。
- **アイコン付与**: 「お気に入り」「履歴」「問題」などに Lucide アイコン（Heart, History, ListOrdered / BookOpen / FileCode 等）を付ける。
- 仕様に明示がない場合は 0009 に DD-xxx で記載。

---

## Phase 2: 履歴一覧テーブルの改善

**対象**: src/app/[workbookId]/history/HistoryListClient.tsx。

- **アイコン＋文字**: 列ヘッダー・セルをアイコン＋文字に統一。問題列はリンクにアイコン＋タイトル。
- **問題表示をタイトルに**: クライアントで問題一覧を GET して questionId → title マップを作成し、「問題 q3」ではなく問題タイトルを表示する（API 変更なし）。0009 に DD-xxx で記載。
- **td 内の位置**: 左揃えを維持しつつ、テーブル全体を中央寄せまたは td の padding で中身が左に詰まりすぎないようにする。

---

## Phase 3: パンくずのラベルを ID からタイトル等に変更

**対象**: src/lib/breadcrumb.ts、src/app/components/layout/Breadcrumb.tsx。

- ワークスペース（問題ページ）: pathname が /[wb]/questions/[qId] のとき、Breadcrumb 内で GET /api/workbooks/[wb]/questions/[qId] を呼び、取得した title を最終セグメントのラベルに使う。
- 履歴詳細: GET /api/.../histories/[historyId] で履歴を取得し、questionId から問題タイトルを取得するか「履歴詳細」固定。0009 に DD-xxx で記載。
- buildBreadcrumbs は path ベースのため、Breadcrumb 側で state に「最終セグメントのラベル上書き」を持ち、useEffect で API 取得してセットする。

---

## Phase 4: ワークスペース「Retry」挙動の修正

**対象**: src/core/plugins/python-analysis/index.tsx。

- 採点結果ブロックから Retry ボタンを削除する。
- ツールバーの「解答送信」を、採点結果表示後は「Retry」にラベル変更する。押下時に状態をリセット（setJudgeResult(null)、setResultTileVisible(false) 等）したうえで再び handleRun を実行する。
- 0009 に DD-xxx で「採点結果後の Retry はツールバーで行い、結果ブロック内の Retry は廃止」と記載。

---

## Phase 5: 下書きの保存フィードバックと導線（DRAFT）

**対象**: ワークスペースの下書き保存、問題一覧タイル、新規 API。

- **DRAFT 関連の ID**: 要件は既存続き（例 FR-F030 以降）、API は API-021（下書き一覧）等、テストは TEST-01 に DRAFT 用セクションを追記。テスト仕様書・テスト実装の両方を行う。
- **保存されたか分からない**: 下書き保存成功時に brief フィードバック（例: ボタン横に「保存しました」を 2～3 秒表示、または aria-live）。
- **下書きの保存場所・アクセス**（0009 に DD-xxx）:
  - 問題一覧の各タイルで「お気に入り」と「Try」の間に「アイコン＋Draft」を追加。
  - Draft 押下でその問題のワークスペースに遷移（下書きがあれば復元済み）。
  - 下書きがない場合は Draft ボタンをグレーアウトして押下不可。
- **新規 API**: GET /api/workbooks/{workbookId}/drafts?X-Client-Id で下書きがある questionId の一覧を返す。API-01・openapi.yaml・99_diff に API-021 等で記載。
- QuestionListClient で useDraftSet(workbookId) のような hook で questionIds with draft を取得し、タイル footer にお気に入り → Draft → Try の順で並べる。

---

## Phase 6: コード欄の mock 反映とテキストエリアの見た目

**対象**: src/core/plugins/python-analysis/index.tsx、src/app/globals.css（必要なら）。セルイメージは docs/.drafts/pyvalue5.html も参考（デザインは mock.html 優先）。

- **mock のコード欄**: mock.html の複数 cell-group-ws、各 cell-box、cell-actions（追加・削除・Run）を再現。
- **セル複数対応**: セル配列（cells）で管理。各セルに Run・追加・削除。.cell-group-ws、.cell-box、.cell-actions、.btn-cell-run、.btn-add-cell、.btn-delete-cell。
- **セル単位 Run**: そのセルだけ実行し、実行結果を Variable Watcher に表示する。**加えて、実行結果をそのセルの下にも表示する。**
- **追加・削除**: セル追加（下に挿入）、セル削除。userAnswer は { cells: [{ id, content }, ...] } で保存・送信。
- **テキストエリアが真っ白**: 入力欄の background・color を var(--color-bg-main)、var(--color-text) で確実に指定。textarea 自体に background/color を当てる。
- ワークスペースは最重要のため、セル UI はモダンでクールに。0009 に DD-xxx で記載。

---

## Phase 7: 問題作成画面の「保存しました。」削除

**対象**: src/app/admin/[workbookId]/QuestionEditorClient.tsx。

- 保存成功時はメッセージをセットせずに即 window.location.href = backUrl する。0009 に DD-xxx で記載。

---

## Phase 8: 実装順序と 99_history

1. 0009 作成後、Phase 1 ～ 7 の順で実装。各コミットで「feat(DD-0xx): 説明」または「fix(DD-0xx): 説明」のように ID を記載。
2. 実装後、docs/99_history に「細部修正（DD-001～xxx）」を連番で報告。コミットは -F .git_commit_msg.txt（日本語時）に従う。

---

## Phase 9: 単体・結合・E2E テスト実行、報告書作成、コミット

1. **単体テスト実行**: `npm run test`（Vitest）を実行。失敗があれば修正し、全件パスするまで対応する。
2. **結合テスト実行**: プロジェクトで定義している結合テスト（例: src/tests/integration/）を実行。失敗があれば修正し、全件パスするまで対応する。
3. **E2E テスト実行**: `npm run test:e2e`（Playwright）を実行。必要なら `npm run test:e2e:prod` も実行。失敗があれば修正し、全件パスするまで対応する。
4. **報告書作成**: docs/99_history/ に連番の報告書（例: 00XX_細部修正_実施報告.md）を作成。実施内容（Phase 0～8 の要約）、テスト結果（単体・結合・E2E の成否、失敗時は理由と修正内容）、DRAFT 関連の要件 ID・API ID・テスト ID 一覧を記載する。
5. **コミット**: コミットメッセージは .cursor/rules に従い、日本語の場合は `git commit -F .git_commit_msg.txt` を使用。メッセージに DD-xxx / FR-F0xx / API-021 等の ID を記載する。

---

## 注意・依存

- 履歴の questionTitle: クライアントで問題一覧からマップするため API 変更なし。
- 下書き一覧 API: 新設時は 03_contracts と 99_diff の両方に ID 付きで記載。
- Breadcrumb のタイトル取得: クライアントで fetch するため、初回表示はパスセグメント（ID）のままになり、取得後にタイトルに差し替わる。
