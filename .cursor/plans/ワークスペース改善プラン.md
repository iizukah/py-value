# ワークスペース改善プラン

## 概要

ワークスペースのローディング表示・セル入力の視認性・ペースト処理・採点結果ラベル・スクロールバー・ローディング縦揃え・問題文の Markdown/数式表示の 7 項目を、仕様 ID に紐づけて修正する。以下に記載の「確認済み回答」を実装の前提とする。

## 確認済み回答（プラン反映）

| # | 質問 | 回答 | 実装時の扱い |
|---|------|------|----------------|
| 1 | ローディングで隠す範囲 | 準備中・採点中 | Pyodide 準備中と、採点中・セル実行中の**両方**でコード入力ペインを隠す（オーバーレイで完全に覆うか、該当中は中央ペインを出さない）。 |
| 2 | セル背景のトーン | 文字との差をつける方針 | セル入力エリアの背景を `--color-bg-secondary` 等にして、文字色との差を明確にする。 |
| 3 | ペーストで HTML 実体が入る状況 | プレーンテキストのみ貼り付けでも発生 | ペースト後の文字列に HTML 実体デコード（&#39; → ' 等）を必ずかける。 |
| 4 | 「問題集」の表記 | はい | 採点結果時の中央ペイン見出しを「問題一覧」→「次の問題に挑戦！」に変更。他に「問題集」表記の変更は不要。 |
| 5 | スクロールバーを付ける対象 | 前者 | スクロールバーを整えるのは「セルが複数あるときに縦にスクロールする中央ペイン全体」のみ。 |
| 6 | 「垂直揃え」の意味 | 後者 | アニメーションと文言は**縦並びのまま**、ブロック全体を中央寄せで揃える（横並びにはしない）。 |
| 7 | どのローディングか | 全部 | **3 箇所とも**縦揃えを修正：Pyodide 準備中、採点中・セル実行中、共通 LoadingOverlay。 |
| 8 | 問題文 Markdown の仕様 | 前者 | 問題文は GFM 想定（表・コードブロック・リスト等を含む）。 |
| 9 | 数式の記法 | 両方 | 数式は `$...$`（インライン）と `$$...$$`（ブロック）の両方に対応。 |
| 10 | 問題文の信頼性（HTML 許可） | 許可 | 問題文で HTML を許可（`rehype-raw` 使用）。XSS 対策として **rehype-sanitize** で許可タグ・属性を限定する。 |

---

## 参照箇所

- **ワークスペース本体**: `src/core/plugins/python-analysis/index.tsx`（3-pane、採点結果、セル一覧、Pyodide/採点・実行中ローディング）
- **セル入力**: `src/core/plugins/python-analysis/CodeInputWithHighlight.tsx`（テキストエリア＋シンタックスハイライト overlay、onPaste）
- **グローバルスタイル**: `src/app/globals.css`（DD-043 スクロールバー、result-grading-loading、three-pane .pane）
- **共通ローディング**: `src/app/components/layout/LoadingOverlay.tsx`

---

## 1. ローディング中にコード入力ペインを見せない

- **対象**: Pyodide 準備中 + 採点中・セル実行中（回答 1）。
- **方針**: オーバーレイを完全に不透明にするか、ローディング中は 3-pane の中央ペインを描画しない。
- **変更**: `index.tsx` の Pyodide 用オーバーレイ（299–325 行）および採点中/実行中オーバーレイ（576–604 行）。背面が透けないよう `opacity: 1` と背景を明示するか、該当時は中央ペインを出さない。

---

## 2. セル背景と入力文字色のコントラスト・ペースト時の HTML 実体

- **背景色**: セル領域（cell-box または入力ラッパー）を `var(--color-bg-secondary)` にし、文字（`--color-text`）と差をつける（回答 2）。
- **ペースト**: `CodeInputWithHighlight.tsx` の `handlePaste` で、`getData("text/plain")` 取得後に HTML 実体デコードを適用してから `onChange` に渡す（回答 3）。
- **変更**: `index.tsx` の cell-box / CodeInputWithHighlight の style。`CodeInputWithHighlight.tsx` にデコード処理を追加。

---

## 3. 採点結果時の「問題一覧」→「次の問題に挑戦！」

- **変更**: `index.tsx` 518–520 行付近の `<span className="label ...">問題一覧</span>` を「次の問題に挑戦！」に変更（回答 4）。
- **仕様**: 99_diff に DD または CD として 1 行追記。

---

## 4. セルが多くなったときのコードペインのスクロールバー

- **対象**: セルが複数あるときに縦にスクロールする中央ペイン全体のみ（回答 5）。
- **方針**: 中央ペインに `workspace-code-pane` を付与し、`globals.css` で `.workspace-code-pane` に DD-043 と同トーンの scrollbar スタイルを追加。

---

## 5. ローディング中のアニメーションと「読み込み中」の垂直揃え

- **対象**: 3 箇所すべて（回答 7）— Pyodide 準備中、採点中・セル実行中、共通 LoadingOverlay。
- **方針**: 縦並びのまま、アニメーション＋文言を 1 ブロックとして中央寄せ（回答 6）。ラッパーに `flex flex-col items-center justify-center gap-2` を付け、余計な margin を gap に置き換える。
- **変更**: `LoadingOverlay.tsx`、`index.tsx` の Pyodide オーバーレイ（299–325 行）と採点/実行中オーバーレイ（576–604 行）。

---

## 6. 問題文の Markdown 表示と数式表示

- **Markdown**: GFM 想定（回答 8）。`react-markdown` + `remark-math` + `rehype-katex`。
- **数式**: `$...$` と `$$...$$` の両方（回答 9）。
- **HTML**: 許可。`rehype-raw` を使用し、XSS 対策で **rehype-sanitize** で許可タグ・属性を限定する（回答 10）。
- **変更**: 依存追加（react-markdown, remark-math, rehype-katex, rehype-raw, rehype-sanitize, katex）。新規コンポーネント `ProblemStatementMarkdown`。`index.tsx` 368–370 行を当該コンポーネントに差し替え。KaTeX CSS の読み込み。

---

## 7. 実装順序・テスト・履歴

- **順序案**: (3)(4) → (1)(5) → (2) → (6)。
- **テスト**: 既存 E2E（例: list-and-workspace.spec.ts）で「次の問題に挑戦！」等の文言を必要に応じて更新。
- **履歴**: 変更内容を `docs/99_history` に 1 件、関連仕様 ID（CD/DD）を付けて記録。
