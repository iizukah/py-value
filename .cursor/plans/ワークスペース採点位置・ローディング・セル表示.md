# ワークスペース 採点位置・ローディング・セル表示（pyvalue5 準拠）

## 概要

1. 採点結果を「問題タイトル（CHALLENGE）」と「問題文」の間に移動する。  
2. ローディングのアニメーションと「準備中」「採点中」の垂直揃えを修正する。  
3. セル表示を **docs/.drafts/pyvalue5.html に合わせ、Prism でハイライト**する（textContent + highlightElement。HTML 文字列を組まないため &#39; やマークアップの露出を防ぐ）。

---

## 参照

- **左ペイン・採点結果**: [src/core/plugins/python-analysis/index.tsx](src/core/plugins/python-analysis/index.tsx) 335–443 行
- **ローディング**: 同 300–330 行（準備中）、576–608 行（採点中/実行中）。[LoadingOverlay.tsx](src/app/components/layout/LoadingOverlay.tsx)
- **セル**: [CodeInputWithHighlight.tsx](src/core/plugins/python-analysis/CodeInputWithHighlight.tsx)、[python-highlight.ts](src/core/plugins/python-analysis/python-highlight.ts)
- **pyvalue5 のセル**: [docs/.drafts/pyvalue5.html](docs/.drafts/pyvalue5.html) 204–234 行（syncEditor: textContent + Prism.highlightElement、textarea は透明オーバーレイ）

---

## 1. 採点結果の位置変更

- **現在**: 左ペインの順序は「tile-header（CHALLENGE・タイトル・タグ）→ 問題文 → 採点結果」。
- **変更後**: 「tile-header → **採点結果** → 問題文」にする。
- **実施**: `index.tsx` の `workspace-problem-pane` 内で、採点結果ブロック `{(displayJudging || displayResult) && (...)}` を、tile-header の直後（閉じ `</div>` の直後）に移動し、その後に `workspace-problem-readability`（問題文）を置く。

---

## 2. ローディングの垂直揃え

- **方針**: アニメーション（stats-loader）と「準備中」「採点中」の文字が 1 ブロックとして縦に揃うようにする。
- **変更**: 次の 3 箇所で、`stats-loader` のクラスを `items-end` → `items-center` に変更する。
  - Pyodide 準備中オーバーレイ（index.tsx 309 行付近）
  - 採点中/実行中オーバーレイ（index.tsx 578 行付近）
  - 共通 LoadingOverlay（LoadingOverlay.tsx 45 行付近）
- 既存の `flex flex-col items-center justify-center gap-2` ラッパーはそのまま利用する。

---

## 3. セルを pyvalue5 に寄せる（Prism ハイライト）

**pyvalue5 のやり方**: 生コードを `<code>` の **textContent** に入れ、**Prism.highlightElement(code)** で DOM をハイライト。HTML 文字列を組み立てないため、`&#39;` や `class="py-string"` 等が画面に出ない。

**方針**:

- **ハイライト層を Prism に差し替える**
  - 現在: 自前の `highlightPython()` が HTML 文字列を返し、`<code dangerouslySetInnerHTML={{ __html: highlighted }}>` で表示。
  - 変更後: `<code>` に **textContent** で生の `value` を設定し、**Prism.highlightElement(code)** でハイライト。React では `useRef` で code 要素を参照し、`value` 変更時（および初回）に `codeRef.current.textContent = value; Prism.highlightElement(codeRef.current);` を実行する。
- **パッケージ**: 既存の `prismjs` と `prismjs/components/prism-python` を利用。テーマ用 CSS は既存の読み込みがあればそのまま、なければ `prism-tomorrow` 等を 1 本読み込む。
- **ペースト・取り込み時**
  - ペースト: 従来どおり `getData("text/plain")` を取得し、**decodeHtmlEntities** をかけてから `onChange` に渡す（CodeInputWithHighlight で維持）。
  - 初期値・下書き: `index.tsx` でセル内容を初期化・復元する箇所（`initialCells`、`initialAnswer` から `setCells` する useEffect、`handleReset`）で、各 `content` に **decodeHtmlEntities** をかけてから state に渡す。`decodeHtmlEntities` は CodeInputWithHighlight からユーティリティとして切り出し（例: `decode-html-entities.ts`）、両方から利用する。
- **自前ハイライトの扱い**: `python-highlight.ts` および CodeInputWithHighlight 内の `highlightPython` 呼び出しを削除し、Prism のみを使う。

**変更候補**:

- 新規: `src/core/plugins/python-analysis/decode-html-entities.ts`（CodeInputWithHighlight から移動した decodeHtmlEntities）。index と CodeInputWithHighlight の両方で import。
- [CodeInputWithHighlight.tsx](src/core/plugins/python-analysis/CodeInputWithHighlight.tsx):  
  - `<pre>` 内の `<code>` を ref で保持。`value` 変更時に `codeRef.current.textContent = value ?? "";` してから `Prism.highlightElement(codeRef.current)` を実行（useEffect または render 直後の同期）。  
  - `dangerouslySetInnerHTML` をやめる。`highlightPython` の import を削除。  
  - スタイルは Prism 用クラス（`.token` 等）に合わせるか、既存の `.py-keyword` 系を Prism のテーマで上書き。  
  - ペースト処理は decodeHtmlEntities を import してそのまま使用。
- [index.tsx](src/core/plugins/python-analysis/index.tsx): 初期セル・`initialAnswer` 復元・`handleReset` で、各セルの `content` に decodeHtmlEntities をかけてから setCells / 初期値に渡す。
- [python-highlight.ts](src/core/plugins/python-analysis/python-highlight.ts): 使用しなくなるため削除するか、残す場合は他から参照されないようにする（削除推奨）。

---

## 4. 実装順序・テスト・履歴

1. 採点結果の位置変更（1）  
2. ローディングの縦揃え（2）  
3. decodeHtmlEntities の切り出しと index でのデコード適用  
4. CodeInputWithHighlight の Prism 化（pre/code を ref、textContent + highlightElement）  
5. python-highlight の参照削除・ファイル削除または未使用化  

変更後、既存のワークスペース関連 E2E が通ることを確認する。必要に応じて `docs/99_history` に 1 件追記する。
