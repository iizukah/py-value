<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Py-Value | Advanced Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --bg-main: #0d1117;
            --bg-panel: #161b22;
            --accent-emerald: #10b981;
            --border-color: #30363d;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: #e6edf3; }
        .glass-panel { background: var(--bg-panel); border-left: 1px solid var(--border-color); }
        .cell-group { border-left: 4px solid transparent; transition: all 0.2s; border-bottom: 1px solid var(--border-color); }
        
        /* --- Original Loader Animation --- */
        .stats-loader { width: 120px; height: 60px; display: flex; align-items: flex-end; gap: 4px; }
        .stats-bar { 
            width: 8px; background: linear-gradient(to top, #3b82f6, #10b981); 
            animation: stats-grow 1.5s ease-in-out infinite; border-radius: 2px 2px 0 0; 
        }
        .stats-bar:nth-child(1) { height: 20%; animation-delay: 0.1s; }
        .stats-bar:nth-child(2) { height: 50%; animation-delay: 0.2s; }
        .stats-bar:nth-child(3) { height: 80%; animation-delay: 0.3s; }
        .stats-bar:nth-child(4) { height: 100%; animation-delay: 0.4s; }
        .stats-bar:nth-child(5) { height: 80%; animation-delay: 0.5s; }
        .stats-bar:nth-child(6) { height: 50%; animation-delay: 0.6s; }
        .stats-bar:nth-child(7) { height: 20%; animation-delay: 0.7s; }
        @keyframes stats-grow { 0%, 100% { transform: scaleY(1); opacity: 0.5; } 50% { transform: scaleY(1.3); opacity: 1; } }
        
        .scanning-line { width: 200px; height: 2px; background: rgba(16, 185, 129, 0.2); position: relative; overflow: hidden; margin-top: 20px; }
        .scanning-line::after {
            content: ""; display: block; width: 40px; height: 100%; background: #10b981;
            box-shadow: 0 0 15px #10b981; animation: scan 2s linear infinite;
        }
        @keyframes scan { from { left: -40px; } to { left: 200px; } }

        .editor-wrapper { 
            position: relative; 
            background: #0d1117; 
            border: 1px solid var(--border-color);
            border-radius: 4px; 
            min-height: 120px;
            overflow: hidden;
        }

        .code-base {
            margin: 0 !important;
            padding: 16px !important;
            font-family: 'Fira Code', monospace !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            white-space: pre !important;
            box-sizing: border-box !important;
            tab-size: 4;
        }

        .code-input {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;
            color: transparent; background: transparent; caret-color: #e6edf3;
            resize: none; outline: none; overflow: auto !important; border: none;
        }

        .code-highlight-pre {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
            pointer-events: none; background: transparent !important; overflow: hidden !important;
        }

        #plot-area img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .judge-success { background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; }
        .judge-fail { background: rgba(248, 113, 113, 0.1); border: 1px solid #f87171; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="h-14 flex items-center justify-between px-6 border-b border-gray-800 bg-[#161b22] z-50">
        <div class="flex items-center gap-3">
            <div class="w-5 h-5 bg-emerald-500 rounded-sm rotate-45"></div>
            <h1 class="text-lg font-bold tracking-tighter text-emerald-400 italic">Py-Value</h1>
        </div>
        <div id="pyodide-status" class="text-[10px] font-mono text-gray-500 uppercase">SYSTEM INITIALIZING...</div>
        <button id="submit-btn" class="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-1 rounded font-bold transition shadow-lg shadow-emerald-900/20 uppercase text-[11px]">採点 / Judge</button>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <aside class="w-[25%] flex flex-col border-r border-gray-800 p-6 space-y-8 bg-[#0d1117] overflow-y-auto">
            <div>
                <span class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest px-2 py-1 bg-emerald-500/10 rounded">Advanced Time Series</span>
                <h2 class="text-lg font-bold mt-4 text-white leading-tight uppercase">月次売上の時系列分析</h2>
                <div class="text-[11px] text-gray-400 leading-relaxed mt-4 space-y-3">
                    <p><code>monthly_sales.csv</code> を分析し、定常性の判定とモデル選定を行ってください。</p>
                    <ol class="list-decimal ml-4 space-y-2">
                        <li>ADF検定を行い、元のp値を <code>p_adf</code> に代入。</li>
                        <li>1次階差をとり、そのp値を <code>p_adf_diff</code> に代入。</li>
                        <li>AR(1)モデルを構築し、そのAICを <code>ans</code> に代入。</li>
                        <li>階差データの自己相関関数(ACF)を表示してください。</li>
                    </ol>
                </div>
            </div>
            <div class="p-4 rounded border border-gray-800 bg-[#010409]">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-3">Variable Watcher</h3>
                <div class="space-y-2 font-mono text-[10px]">
                    <div class="flex justify-between text-blue-400">
                        <span class="text-gray-600">p_adf =</span> <span id="p-adf-display">-</span>
                    </div>
                    <div class="flex justify-between text-blue-400">
                        <span class="text-gray-600">p_adf_diff =</span> <span id="p-adf-diff-display">-</span>
                    </div>
                    <div class="flex justify-between text-emerald-400">
                        <span class="text-gray-600">ans (AIC) =</span> <span id="ans-display">-</span>
                    </div>
                </div>
            </div>
            <div id="judge-result-box" class="hidden p-4 rounded text-[11px] leading-relaxed"></div>
        </aside>

        <section class="flex-1 flex flex-col relative bg-[#0d1117] overflow-y-auto border-r border-gray-800">
            <div id="loading-overlay" class="absolute inset-0 z-[100] flex flex-col items-center justify-center bg-[#0d1117]">
                <div class="stats-loader">
                    <div class="stats-bar"></div><div class="stats-bar"></div><div class="stats-bar"></div><div class="stats-bar"></div><div class="stats-bar"></div><div class="stats-bar"></div><div class="stats-bar"></div>
                </div>
                <div class="scanning-line"></div>
                <p class="mt-8 text-[10px] font-mono text-emerald-400 tracking-[0.3em] animate-pulse">LOADING STATSMODEL KERNEL...</p>
            </div>
            <div id="cell-container" class="flex-1 pb-20"></div>
            <div id="add-cell-area" class="p-6 flex justify-center sticky bottom-0 bg-gradient-to-t from-[#0d1117] to-transparent hidden">
                <button onclick="addCell('')" class="px-4 py-2 bg-[#161b22] border border-gray-700 rounded text-gray-400 hover:text-white transition-all text-[10px] font-bold tracking-widest">+ ADD CELL</button>
            </div>
        </section>

        <aside class="w-[30%] flex flex-col glass-panel bg-[#0d1117]">
            <div class="p-4 border-b border-gray-800 bg-[#161b22]/50 text-[10px] font-bold text-gray-500 uppercase tracking-widest">Result Plot</div>
            <div id="plot-area" class="flex-1 p-6 flex items-center justify-center overflow-y-auto text-gray-700 italic text-[10px]">No graphics rendered</div>
        </aside>
    </main>

    <script>
        let pyodide = null;

        async function init() {
            try {
                pyodide = await loadPyodide();
                await pyodide.loadPackage(['pandas', 'matplotlib', 'numpy', 'statsmodels']);
                
                // --- Data Provisioning & Setup ---
                await pyodide.runPythonAsync(`
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
import pandas as pd
import numpy as np
import io, base64
from statsmodels.tsa.stattools import adfuller

# 擬似時系列データの生成 (ランダムウォーク + トレンド)
np.random.seed(42)
steps = 100
sales = np.cumsum(np.random.normal(1, 2, steps)) + 50
pd.DataFrame({'sales': sales}).to_csv('monthly_sales.csv', index=False)

def get_plot():
    if not plt.get_fignums(): return None
    buf = io.BytesIO()
    plt.savefig(buf, format='png', bbox_inches='tight', transparent=True)
    plt.close('all')
    return base64.b64encode(buf.getvalue()).decode('utf-8')
                `);

                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('add-cell-area').classList.remove('hidden');
                document.getElementById('pyodide-status').innerHTML = 'SYSTEM ONLINE';

                // Initial Problem Set
                addCell("# 1. Load Data\nimport pandas as pd\nfrom statsmodels.tsa.stattools import adfuller\n\ndf = pd.read_csv('monthly_sales.csv')\nprint(df.head())");
                addCell("# 2. Unit Root Test\n# 元データのp値を計算\nres = adfuller(df['sales'])\np_adf = res[1]\nprint(f'Original P-value: {p_adf}')");
                addCell("# 3. Differencing & ARIMA\nfrom statsmodels.tsa.arima.model import ARIMA\nfrom statsmodels.graphics.tsaplots import plot_acf\n\n# 1次階差データの検定\ndiff = df['sales'].diff().dropna()\np_adf_diff = adfuller(diff)[1]\n\n# ARIMA(1,0,0) = AR(1) を階差データに適用\nmodel = ARIMA(diff, order=(1,0,0)).fit()\nans = model.aic\n\n# ACFのプロット\nplot_acf(diff)\nplt.show()");

            } catch (e) { console.error(e); }
        }

        function syncEditor(id) {
            const input = document.getElementById(`input-${id}`);
            const highlightCode = document.getElementById(`highlight-${id}`);
            const highlightPre = input.previousElementSibling;
            const wrapper = input.parentElement;

            let code = input.value;
            if (code[code.length - 1] === "\n") code += " ";
            highlightCode.textContent = code;
            Prism.highlightElement(highlightCode);

            highlightPre.scrollTop = input.scrollTop;
            highlightPre.scrollLeft = input.scrollLeft;
            
            input.style.height = 'auto';
            const height = Math.max(120, input.scrollHeight);
            input.style.height = height + 'px';
            wrapper.style.height = height + 'px';
        }

        function addCell(content) {
            const container = document.getElementById('cell-container');
            const id = container.querySelectorAll('.cell-group').length + 1;
            const div = document.createElement('div');
            div.className = "cell-group p-6";
            div.innerHTML = `
                <div class="flex justify-between mb-2 text-[9px] font-mono text-gray-600">
                    <span>In [${id}]</span>
                    <button onclick="runCell(this)" class="px-3 py-1 bg-emerald-600/20 text-emerald-400 border border-emerald-500/30 rounded hover:bg-emerald-600 hover:text-white transition font-bold">RUN</button>
                </div>
                <div class="editor-wrapper">
                    <pre class="code-highlight-pre code-base language-python"><code class="language-python" id="highlight-${id}"></code></pre>
                    <textarea class="code-input code-base" id="input-${id}" spellcheck="false" oninput="syncEditor(${id})" onscroll="document.getElementById('highlight-${id}').parentElement.scrollTop=this.scrollTop;document.getElementById('highlight-${id}').parentElement.scrollLeft=this.scrollLeft" onkeydown="handleTab(event, ${id})"></textarea>
                </div>
                <div class="output-area mt-4 hidden">
                    <div class="stdout font-mono text-[11px] text-gray-400 whitespace-pre bg-[#010409] p-3 border border-gray-800 overflow-x-auto"></div>
                </div>
            `;
            container.appendChild(div);
            const textarea = document.getElementById(`input-${id}`);
            textarea.value = content;
            syncEditor(id);
        }

        function handleTab(e, id) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = e.target.selectionStart;
                const end = e.target.selectionEnd;
                e.target.value = e.target.value.substring(0, start) + "    " + e.target.value.substring(end);
                e.target.selectionStart = e.target.selectionEnd = start + 4;
                syncEditor(id);
            }
        }

        async function runCell(btn) {
            const cell = btn.closest('.cell-group');
            const id = cell.querySelector('textarea').id.split('-')[1];
            const code = document.getElementById(`input-${id}`).value;
            const stdoutEl = cell.querySelector('.stdout');
            const plotArea = document.getElementById('plot-area');
            
            cell.querySelector('.output-area').classList.remove('hidden');
            stdoutEl.innerText = "Processing...";

            try {
                await pyodide.runPythonAsync("import sys, io\nsys.stdout = io.StringIO()");
                await pyodide.runPythonAsync(code);
                const stdout = pyodide.runPython("sys.stdout.getvalue()");
                const plotData = await pyodide.runPythonAsync("get_plot()");

                stdoutEl.innerText = stdout || "> Execution completed";
                if(plotData) plotArea.innerHTML = `<img src="data:image/png;base64,${plotData}" class="animate-in fade-in duration-700" />`;
                
                // Update Watcher
                const p_adf = pyodide.globals.get('p_adf');
                const p_adf_diff = pyodide.globals.get('p_adf_diff');
                const ans = pyodide.globals.get('ans');
                
                if (p_adf !== undefined) document.getElementById('p-adf-display').textContent = p_adf.toFixed(4);
                if (p_adf_diff !== undefined) document.getElementById('p-adf-diff-display').textContent = p_adf_diff.toFixed(4);
                if (ans !== undefined) document.getElementById('ans-display').textContent = ans.toFixed(2);
            } catch (err) { stdoutEl.innerHTML = `<span class="text-red-400">${err}</span>`; }
        }

        document.getElementById('submit-btn').onclick = () => {
            const p_adf = pyodide.globals.get('p_adf');
            const p_adf_diff = pyodide.globals.get('p_adf_diff');
            const ans = pyodide.globals.get('ans');
            const resultBox = document.getElementById('judge-result-box');
            resultBox.classList.remove('hidden');

            if (p_adf > 0.05 && p_adf_diff < 0.05 && ans > 0) {
                resultBox.className = "judge-success p-4 rounded text-[11px] leading-relaxed text-emerald-400 mt-4";
                resultBox.innerHTML = "<strong>PASS:</strong> 正解です！定常性の判定プロセスとモデル構築が完璧です。";
            } else {
                resultBox.className = "judge-fail p-4 rounded text-[11px] leading-relaxed text-red-400 mt-4";
                resultBox.innerHTML = "<strong>FAIL:</strong> p値の判定、またはAICの計算に誤りがあるようです。";
            }
        };

        init();
    </script>
</body>
</html>