# デプロイマニュアル（EXER）

## 1. 概要

本ドキュメントは、**現在の構成**で本番デプロイを試す際の手順をまとめる。IAM 権限・サービス有効化・環境変数を詳細に記載し、**人間が実施する作業**と**Cursor（またはスクリプト）が自動化できる作業**を明示する。

- **対象**: 初回デプロイを実施する担当者（人間）および Cursor エージェント
- **前提**: 開発環境は `docs/02_manuals/01_環境構築マニュアル.md` のとおり構築済み
- **仕様の正本**: `docs/01_specs/06_operations/INFRA-01_operations_and_deploy.md`（INFRA-01）

---

## 2. 現在の構成とデプロイ先

| 項目 | 内容 |
|------|------|
| フロント・API | Next.js（App Router）。API ルートあり（`/api/workbooks` 等）。 |
| 実行環境（本番） | **Cloud Run**（Next.js を Docker でビルド・実行）。同一 GCP プロジェクト内。 |
| ホスティング | Firebase Hosting。全リクエストを Cloud Run サービス（`exer-next`）に **rewrites** で転送。 |
| データベース（本番） | Firebase Firestore。 |
| デプロイの流れ | (1) **Cloud Run にコンテナデプロイ**（`gcloud run deploy`）→ (2) **Firebase Hosting と Firestore ルールをデプロイ**（`firebase deploy`）。 |

**インターネット経由での動作確認**: 上記の順でデプロイ後、Firebase Hosting の URL（例: `https://PROJECT_ID.web.app`）にアクセスすると、Next アプリ（API 含む）が動作する。Cloud Run のデフォルトサービスアカウントに Firestore の読み書き権限があれば、本番データで表示できる。

---

## 3. 人間が実施する作業 と Cursor（自動化）が実施できる作業

### 3.1 人間が実施する作業（必須）

以下の作業は **ブラウザでの操作・コンソールでの設定・秘密情報の扱い** のため、人間が実施する。

| 番号 | 作業内容 | 理由 / 補足 |
|------|----------|-------------|
| 1 | **Firebase / Google Cloud プロジェクトの作成** | Google アカウントでのログイン・支払い設定・プロジェクト名の決定が必要。 |
| 2 | **必要な Google Cloud / Firebase の API の有効化** | **Cursor が実行可能**: `gcloud services enable` で有効化できる（§7 参照）。 |
| 3 | **IAM ロールの付与**（デプロイ用・実行用のサービスアカウントや自分のアカウントへ） | **Cursor が実行可能**（PROJECT_ID とメールが既知の場合）: `gcloud projects add-iam-policy-binding`（§7 参照）。人間が確認したうえで実行可。 |
| 4 | **本番用の環境変数・シークレットの設定**（Firebase Console や Secret Manager 等） | 本番の `ADMIN_KEY` 等は人間が値を決め、リポジトリに載せない。 |
| 5 | **サービスアカウントキー（JSON）の取得と安全な配置** | キーは秘密情報。ダウンロード後、ローカルや CI の秘密にのみ配置。 |
| 6 | **Firebase CLI の初回ログイン**（`firebase login`） | ブラウザが開き、Google アカウントで認証する。 |
| 7 | **Firebase プロジェクトの選択**（`firebase use PROJECT_ID` でプロジェクトを設定） | **Cursor が実行可能**: プロジェクト ID が決まっていれば `firebase use PROJECT_ID` を非対話で実行できる（§7 参照）。 |
| 8 | **デプロイ実行のトリガー**（`firebase deploy` を実行してよいかの Go/No-Go） | 本番反映の判断は人間が行う。 |

### 3.2 Cursor（またはスクリプト）が実施できる作業

以下の作業は、**リポジトリ内のファイル編集・コマンドの実行** で完結するため、Cursor や CI で自動化できる。

| 番号 | 作業内容 | 備考 |
|------|----------|------|
| 1 | **env.example の更新・.env の雛形の生成** | リポジトリにコミットするのはテンプレートのみ。 |
| 2 | **シードデータの配置**（`data/workbooks.json`, `data/questions.json` の編集） | 既存ファイルの更新。 |
| 3 | **シード投入スクリプトの実行**（`node scripts/seed-firestore.mjs`） | 人間が認証情報を用意したうえで、Cursor がコマンド実行可能。 |
| 4 | **ビルドの実行**（`npm run build`） | ローカルまたは CI で実行。 |
| 5 | **Firestore ルールのデプロイ**（`firebase deploy --only firestore`） | `firebase use` 済み・ログイン済みであれば Cursor が実行可能。 |
| 6 | **Hosting のデプロイ**（`firebase deploy --only hosting`） | 同上。静的 `out` をデプロイする場合は事前に `next.config` で `output: 'export'` が必要。 |
| 7 | **ドキュメントの更新**（本マニュアル・INFRA-01・reference.md の追記） | 仕様に合わせた記載の追加・修正。 |

---

## 4. IAM 権限（詳細）

Firebase / Google Cloud でデプロイ・実行するために必要な権限を、**ロール単位**で示す。いずれも **人間がコンソールで付与**する。

### 4.1 デプロイを行う開発者（自分）のアカウントに付与するロール

Firebase CLI（`firebase deploy`）で Hosting / Firestore にデプロイするために、プロジェクトで次を付与する。

| ロール（日本語名） | ロール ID | 用途 |
|--------------------|-----------|------|
| Firebase Admin | `roles/firebase.admin` | Firebase プロジェクトの管理・Hosting へのデプロイ。 |
| Cloud Datastore User（Firestore 用） | `roles/datastore.user` | Firestore データの読み書き。CLI からルールデプロイ時にも利用。 |
| Service Account User | `roles/iam.serviceAccountUser` | デプロイ時にビルド等でサービスアカウントを利用する場合に必要になることがある。 |

**最小限でよい場合**:  
- **Firebase Hosting のみ** デプロイする: **Firebase Admin** または **Editor**（`roles/editor`）で足りる場合が多い。  
- **Firestore ルール** もデプロイする: 上記に加え、Firestore の「ルール」を更新する権限が必要。Firebase Admin に含まれる。

**付与手順（人間が実施）**  
1. [Google Cloud Console](https://console.cloud.google.com/) で対象プロジェクトを選択する。  
2. **IAM と管理** → **IAM** を開く。  
3. 自分のメールを選択（または「アクセスを許可」で追加）。  
4. **ロールを追加** で上記ロールを付与する。

### 4.2 本番アプリ（Cloud Functions やサーバ）が Firestore にアクセスする場合

Next を Cloud Functions で動かす場合、その **Functions の実行用サービスアカウント** に Firestore の読み書き権限が必要。

| ロール（日本語名） | ロール ID | 用途 |
|--------------------|-----------|------|
| Cloud Datastore User | `roles/datastore.user` | Firestore の読み書き。 |

デフォルトの「App Engine のデフォルト サービス アカウント」や Cloud Functions のデフォルト SA には、多くの場合すでに広めの権限が付いている。本番で「Permission denied」が出た場合に、上記ロールを付与する。

### 4.3 シード投入スクリプトを実行する場合（ローカルまたは CI）

`node scripts/seed-firestore.mjs` を実行するアカウントには、Firestore への **書き込み** 権限が必要。

| 方法 | 必要な権限 |
|------|------------|
| **Application Default Credentials（`gcloud auth application-default login` 済み）** | その Google アカウントに `roles/datastore.user` を付与。 |
| **サービスアカウントキー（JSON）を `GOOGLE_APPLICATION_CREDENTIALS` で指定** | そのサービスアカウントに `roles/datastore.user` を付与。 |

サービスアカウントキーの作成（人間が実施）:  
1. **IAM と管理** → **サービス アカウント** → **サービス アカウントを作成**。  
2. 名前（例: `exer-seed`）を入力して作成。  
3. **キー** → **鍵を追加** → **新しい鍵を作成** → JSON をダウンロード。  
4. ダウンロードした JSON を安全な場所に保存し、`GOOGLE_APPLICATION_CREDENTIALS` にそのパスを設定する。

---

## 5. サービス有効化（必要な API・機能）

以下を **人間が Firebase / Google Cloud コンソールで有効化**する。

### 5.1 Firebase 側

| サービス | 有効化手順 |
|----------|------------|
| **Firebase Hosting** | [Firebase Console](https://console.firebase.google.com/) → 対象プロジェクト → **Hosting** → 「始める」で有効化。 |
| **Cloud Firestore** | 同じく **Firestore Database** → 「データベースを作成」で有効化。本番は「本番モード」で開始し、ルールは `firebase deploy --only firestore` で反映する。 |

### 5.2 Google Cloud 側（必要な場合）

Firebase プロジェクトは背後で Google Cloud プロジェクトと同一。以下は Firestore や Hosting 利用時に自動で有効になることが多いが、**Cloud Run で Next を動かす場合は Cloud Run API の有効化が必須**。

| API 名 | API ID | 用途 |
|--------|--------|------|
| **Cloud Firestore API** | `firestore.googleapis.com` | Firestore の利用。 |
| **Firebase Hosting API** | `firebasehosting.googleapis.com` | Hosting へのデプロイ。 |
| **Cloud Run API** | `run.googleapis.com` | Next アプリを Cloud Run で実行する場合に必要。 |

**有効化手順（人間が実施）**  
1. [Google Cloud Console](https://console.cloud.google.com/) → 対象プロジェクト。  
2. **API とサービス** → **ライブラリ** で上記 API を検索。  
3. **有効にする** をクリック。

---

## 6. 環境変数（詳細一覧）

### 6.1 アプリケーションが参照する環境変数

| 変数名 | 必須 | 説明 | 開発時の例 | 本番での設定場所 |
|--------|------|------|------------|------------------|
| `DATA_SOURCE` | はい | データソース種別。`lowdb` \| `firestore` | `lowdb` | Firebase Console（Functions の環境変数）または Hosting に紐づく Functions / 実行環境で設定。Vercel の場合は Vercel の Environment Variables。 |
| `LOWDB_PATH` | 条件付き | Lowdb の JSON を置くディレクトリ。`DATA_SOURCE=lowdb` のときのみ使用。 | `./data` | 本番で lowdb を使う場合のみ設定。本番は通常 `firestore` のため不要。 |
| `ADMIN_KEY` | はい | 管理 API のクエリ key（`?key=xxx`）。管理画面・管理 API の認証に使用。 | ローカル用の任意文字列 | **本番は必ず人間が値を決め、コンソールのシークレットで設定。** コードや .env にハードコードしない。 |
| `NODE_ENV` | 推奨 | `development` \| `production` | `development` | 本番では `production`。多くのプラットフォームで自動設定。 |

### 6.2 シード投入・デプロイ時にのみ使う環境変数

| 変数名 | 必須 | 説明 | 設定者・設定場所 |
|--------|------|------|------------------|
| `GOOGLE_APPLICATION_CREDENTIALS` | 条件付き | サービスアカウントキー（JSON）の**ファイルパス**。未設定の場合は Application Default Credentials（`gcloud auth application-default login` 等）を使用。 | **人間**がキーを取得し、ローカルまたは CI の秘密にパスを設定。リポジトリにコミットしない。 |

### 6.3 設定場所のまとめ

| 環境 | 設定場所 | 誰が設定するか |
|------|----------|----------------|
| 開発 | ルートの `.env`（env.example をコピーして編集） | 開発者（人間）。Cursor は .env を生成しない（秘密を含むため）。 |
| 本番（Firebase） | Firebase Console → プロジェクトの設定 → 環境変数（Functions 用）。または Secret Manager と連携。 | **人間**が Console で値を入力。 |
| 本番（Vercel） | Vercel ダッシュボード → Project → Settings → Environment Variables | **人間**が値を入力。 |
| シード実行時 | ローカル: `.env` やシェルで `GOOGLE_APPLICATION_CREDENTIALS` を設定。CI: リポジトリの Secrets。 | **人間**がキーを取得・登録。Cursor は `node scripts/seed-firestore.mjs` の**実行**はできる（認証済みなら）。 |

---

## 7. デプロイ手順の流れ（チェックリスト）

### 人間が実施する作業（順不同で事前に実施）

- [ ] Firebase / Google Cloud プロジェクトを作成する。
- [ ] 必要な API を有効化する（Firestore, Hosting。§5 参照）。**※Cursor が gcloud で実行可能。下記「Cursor がコマンドで実行可能な作業」を参照。**
- [ ] 自分（デプロイするアカウント）に IAM を付与する（§4.1）。**※Cursor が gcloud で実行可能（PROJECT_ID とメールが既知の場合）。下記参照。**
- [ ] 本番用 `ADMIN_KEY` を決め、Firebase Console（または利用プラットフォーム）の環境変数に設定する。
- [ ] シード投入する場合: サービスアカウントキーを取得し、`GOOGLE_APPLICATION_CREDENTIALS` を設定するか、`gcloud auth application-default login` を実行する。
- [ ] 端末で `firebase login` を実行する（初回のみ。ブラウザが開く）。
- [ ] 本番で使うプロジェクトを決める。**※Cursor が `firebase use PROJECT_ID` で非対話実行可能。下記参照。**
- [ ] **Cloud Run デプロイ前**: ルートの `.env` に `GOOGLE_CLOUD_PROJECT`（または `GCP_PROJECT`）と `ADMIN_KEY` を設定すること。デプロイコマンドはこれらを読み取り専用で参照し、`gcloud run deploy` の `--set-env-vars` に渡す。`.env` はリポジトリにコミットしない。

### Cursor がコマンドラインで実行可能な作業（実施済みまたは条件付き）

以下は **gcloud / Firebase CLI がインストール・認証済み** であるときに、Cursor がターミナルから実行できる。

| 作業 | コマンド（PROJECT_ID は実際のプロジェクト ID に置換） | 備考 |
|------|--------------------------------------------------------|------|
| **必要な API を有効化** | `gcloud services enable firestore.googleapis.com --project=PROJECT_ID`<br>`gcloud services enable firebasehosting.googleapis.com --project=PROJECT_ID` | gcloud のデフォルトプロジェクトが未設定の場合は先に `gcloud config set project PROJECT_ID` を実行する。 |
| **Firebase の使用プロジェクトを設定** | `firebase use PROJECT_ID` | `--add` なしでプロジェクト ID を指定すると非対話で完了する。 |
| **IAM ロールの付与**（自分に Firebase Admin を付与） | `gcloud projects add-iam-policy-binding PROJECT_ID --member="user:YOUR_EMAIL" --role="roles/firebase.admin"` | YOUR_EMAIL は Google アカウントのメール。Datastore User も必要なら `--role="roles/datastore.user"` を同様に実行。 |

**前提**: `firebase login` および `gcloud auth login`（または `gcloud auth application-default login`）は **人間が初回に実施**する。ログイン済みであれば上記は Cursor が実行可能。

### Cloud Run + Firebase Hosting のデプロイ手順（フルアプリをインターネットで確認する場合）

1. **Cloud Run API を有効化**（未実施なら）  
   `gcloud services enable run.googleapis.com --project=PROJECT_ID`

2. **Cloud Run にデプロイ**（プロジェクトルートで実行）  
   ```bash
   gcloud run deploy exer-next --source . --region asia-northeast1 --allow-unauthenticated --set-env-vars "DATA_SOURCE=firestore,ADMIN_KEY=本番で決めたキー,GOOGLE_CLOUD_PROJECT=PROJECT_ID"
   ```  
   - `ADMIN_KEY` は人間が決めた本番用の値に置換する。`PROJECT_ID` は実際のプロジェクト ID（例: exir-27624）。  
   - **GOOGLE_CLOUD_PROJECT** を必ず渡す（firebase-admin が Firestore のプロジェクトを特定するため）。  
   - 初回はコンテナビルドのため数分かかることがある。

3. **Firestore にシードデータが入っていること**を確認。未投入なら `GOOGLE_CLOUD_PROJECT=PROJECT_ID node scripts/seed-firestore.mjs` を実行（事前に `gcloud auth application-default login` を人間が実行すること）。

4. **Firebase Hosting と Firestore をデプロイ**  
   ```bash
   firebase deploy --only "hosting,firestore"
   ```  
   - Hosting の全リクエストが Cloud Run の `exer-next`（asia-northeast1）に転送される。  
   - Firestore のルールと **複合インデックス**（`firestore.indexes.json`）もデプロイされる。

5. **動作確認**: ブラウザで `https://PROJECT_ID.web.app`（または表示された Hosting URL）にアクセスする。

### Cursor または人間が実施できる作業

- [ ] `.env` の雛形を用意する（`env.example` をコピー。**値は人間が編集**）。
- [ ] `npm ci` または `npm install` で依存をインストールする。
- [ ] `npm run build` でビルドする。
- [ ] （Firestore を使う場合）シード投入: `node scripts/seed-firestore.mjs` を実行する（認証済みであること）。
- [ ] **Cloud Run デプロイ**: `gcloud run deploy exer-next --source . --region asia-northeast1 --allow-unauthenticated --set-env-vars "DATA_SOURCE=firestore" --set-env-vars "ADMIN_KEY=…"`（§7 上記参照）。
- [ ] **Firebase デプロイ**: `firebase deploy --only hosting,firestore` で Hosting と Firestore ルールをデプロイする。

### デプロイ後の確認（人間が実施）

- [ ] デプロイ先 URL（Hosting の URL）にブラウザでアクセスし、ホーム・問題一覧が表示されることを確認する。
- [ ] 本番で `DATA_SOURCE=firestore` の場合、Firestore にデータが入っていることを Firebase Console で確認する。

---

## 8. Cursor が自動化できる内容（まとめ）

| 分類 | 内容 |
|------|------|
| **API 有効化** | `gcloud services enable run.googleapis.com firestore.googleapis.com firebasehosting.googleapis.com --project=PROJECT_ID` |
| **プロジェクト設定** | `gcloud config set project PROJECT_ID`、`firebase use PROJECT_ID` |
| **IAM 付与** | `gcloud projects add-iam-policy-binding PROJECT_ID --member="user:EMAIL" --role="roles/..."`（PROJECT_ID と EMAIL が既知の場合）。Cloud Build 用に Compute デフォルト SA へ `roles/storage.admin` の付与も可能。 |
| **Cloud Run デプロイ** | `gcloud run deploy exer-next --source . --region asia-northeast1 --allow-unauthenticated --set-env-vars "..." --quiet` |
| **Firebase デプロイ** | `firebase deploy --only "hosting,firestore"`（PowerShell ではカンマ区切りを引用符で囲む） |
| **シード投入** | 認証済みなら `GOOGLE_CLOUD_PROJECT=PROJECT_ID node scripts/seed-firestore.mjs` |
| **ファイル・ドキュメント** | Dockerfile / firebase.json / firestore.indexes.json の編集、マニュアル・99_history の更新、env.example の更新 |

**前提**: `firebase login` と `gcloud auth application-default login`（シード用）は **人間が初回に実施**する。

---

## 9. 人間がやるべき内容（まとめ）

| 分類 | 内容 |
|------|------|
| **プロジェクト・請求** | Firebase / GCP プロジェクトの作成。**請求（ビリング）の有効化**（Cloud Run 等の API 利用に必須）。 |
| **認証** | `firebase login`（初回。ブラウザ）。シード投入前に `gcloud auth application-default login`（初回。ブラウザ）。 |
| **シークレット** | 本番用 `ADMIN_KEY` の決定と Cloud Run の環境変数または Console での設定。サービスアカウントキーを使う場合は JSON の取得と `GOOGLE_APPLICATION_CREDENTIALS` の設定。 |
| **コンソール操作** | Firebase Console で Hosting / Firestore の「始める」やデータベース作成。必要に応じて Functions の「始める」を押下。 |
| **Go/No-Go** | 本番デプロイを実行してよいかの最終判断。 |
| **動作確認** | デプロイ後の URL にアクセスし、ホーム・問題一覧が表示されることを確認。 |

---

## 10. トラブルシューティング

| 現象 | 原因の目安 | 対処 |
|------|------------|------|
| **Cloud Run のビルドが「Billing must be enabled」で失敗** | プロジェクトに請求がリンクされていない。 | **人間**: [Google Cloud Console](https://console.cloud.google.com/billing) で請求先アカウントをプロジェクトにリンクする。 |
| **Cloud Run のビルドが「IAM permission denied」で失敗** | Cloud Build で使うデフォルトサービスアカウント（PROJECT_NUMBER-compute@developer.gserviceaccount.com）にストレージ権限がない。 | **Cursor 実行可**: `gcloud projects add-iam-policy-binding PROJECT_ID --member="serviceAccount:PROJECT_NUMBER-compute@developer.gserviceaccount.com" --role="roles/storage.admin"`（PROJECT_NUMBER はコンソールのプロジェクト設定で確認）。 |
| **「Application error: a server-side exception」** | 本番で firebase-admin が未初期化、または getFirestore が関数として渡っていない。 | アプリ側で `initializeApp({ credential: applicationDefault(), projectId })` を実行し、Firestore リポジトリでは `getFirestoreSafe` を直接 import して呼ぶ構成にする（`src/core/firebase-admin.ts` と firestore リポジトリの実装を参照）。Cloud Run の環境変数に **GOOGLE_CLOUD_PROJECT=PROJECT_ID** を必ず設定する。 |
| **「TypeError: e is not a function」**（getById 等） | ビルド後、`require("../firebase-admin")` の `getFirestoreSafe` が undefined でリポジトリに渡っている。 | Firestore リポジトリ（workbook / question）で引数で受け取らず、**getFirestoreSafe を直接 import してメソッド内で呼ぶ**ように変更する。 |
| **シード実行で「Could not load the default credentials」** | Application Default Credentials が未設定。 | **人間**: `gcloud auth application-default login` を実行し、ブラウザでログイン。その後 `GOOGLE_CLOUD_PROJECT=PROJECT_ID node scripts/seed-firestore.mjs` を実行。スクリプト側で ADC ファイルが無い場合は日本語で案内するエラーに変更済み。 |
| **問題一覧で Firestore のクエリが失敗する** | `questions` の `workbookId` + `status` の複合インデックスが無い。 | `firestore.indexes.json` にインデックスを定義し、`firebase deploy --only firestore` でデプロイ。Firebase Console の「Firestore」→「インデックス」でビルド完了を確認（数分かかることがある）。 |
| **Firebase の「Functions」で「始める」を押した** | Hosting + Cloud Run 構成では Functions は必須ではないが、押しても問題ない。 | 本マニュアルの構成では Hosting が Cloud Run に rewrites しているため、Functions は未使用でよい。 |

**ログの確認**: Cloud Run のエラー詳細は [Google Cloud Console](https://console.cloud.google.com/) → **Cloud Run** → サービス `exer-next` → **ログ** で確認できる。

### 管理画面のキーが .env と本番でずれている場合

本番（Cloud Run）の `ADMIN_KEY` を、ローカルの `.env` に設定した値と揃えたいときは、次のスクリプトを実行する。

```bash
node scripts/sync-admin-key-to-cloudrun.mjs
```

- **前提**: ルートに `.env` があり、`ADMIN_KEY` と `GOOGLE_CLOUD_PROJECT` が設定されていること。`gcloud` がインストール・認証済みであること。
- **動作**: `.env` の `ADMIN_KEY` を読み取り、Cloud Run サービス `exer-next` の環境変数 `ADMIN_KEY` をその値で更新する。実行後、本番の管理画面は `?key=<.env の ADMIN_KEY>` でアクセスできる。

---

## 11. 参照

- 運用・デプロイ仕様: `docs/01_specs/06_operations/INFRA-01_operations_and_deploy.md`
- 環境変数・シークレットの参照: `.cursor/skills/infra-engineer/reference.md`
- 環境変数テンプレート: `docs/01_specs/06_operations/env.example`
- シードデータ: `docs/01_specs/06_operations/seed/README.md`
- 環境構築: `docs/02_manuals/01_環境構築マニュアル.md`
