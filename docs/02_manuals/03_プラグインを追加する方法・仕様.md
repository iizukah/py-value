# プラグインを追加する方法・仕様（EXER）

## 1. 概要

本ドキュメントは、EXER 枠組みに**新規プラグイン**（新たな問題 type）を追加する手順と、必要な型・登録コード・判定アダプタの形を説明する。仕様の正本は REQ-01（プラグイン契約 FR-F016～FR-F022）、ARC-01、ARC-02 を参照する。

---

## 2. 前提

- 枠組みは問題の `type` に応じてレジストリからプラグインを取得する（FR-F017）。
- プラグインは **表示用 React コンポーネント** と **判定アダプタ**（任意）を提供する（FR-F018, FR-F019）。
- 登録は**ビルド時にコードで行う**（FR-F022）。例: `registerPlugin('python-analysis', Component, judgeAdapter)`。

---

## 3. 手順

### 3.1 プラグイン用ディレクトリの作成

- 1 プラグイン 1 ディレクトリで配置する（ARC-01）。
- 例: `src/core/plugins/<plugin-id>/`
- 最低限のファイル:
  - **index.tsx**: 表示用 React コンポーネント（Renderer）。枠組みが渡す props（問題データ、ユーザー解答、コールバック等）を受け取り、ワークスペース UI を描画する。
  - **judge.ts**（任意）: 判定アダプタ。`runJudge(question, userAnswer) => Promise<JudgeResult>` を実装する。
  - **types.ts**（任意）: プラグイン内で使う型。DATA-02 等の契約と整合させる。

### 3.2 必要な型（枠組み契約）

- **JudgeResult**: 枠組みが期待する採点結果の型。DATA-01 または DATA-02（プラグイン用）で定義する。少なくとも `isCorrect: boolean` および必要に応じて `details`, `errorKind` 等を持つ。
- **userAnswer**: プラグインが解釈する形式。下書き・解答送信時に枠組みが永続化・API に載せる。中身の解釈はプラグインが行う（FR-F021）。

### 3.3 レジストリへの登録

- `src/core/plugins/register-plugins.ts`（または同等のエントリ）で、ビルド時に登録する。
- 登録コード例:

```ts
import { registerPlugin } from "@/core/plugins/registry";
import PluginComponent from "@/core/plugins/my-plugin/index";
import { judgeAdapter } from "@/core/plugins/my-plugin/judge";

registerPlugin("my-plugin", PluginComponent, judgeAdapter);
```

- 判定アダプタの形（例）:

```ts
// judge.ts
export const judgeAdapter = {
  async runJudge(question: Question, userAnswer: Record<string, unknown>): Promise<JudgeResult> {
    // プラグイン固有の採点ロジック
    return { isCorrect: true, details: {} };
  },
};
```

### 3.4 問題データの type との対応

- 問題 JSON の `type` フィールドを、登録した ID（例: `"my-plugin"`）に合わせる。
- 枠組みは `getPlugin(question.type)` でコンポーネントと判定アダプタを取得し、表示・解答送信時に利用する。

---

## 4. 参照

- REQ-01 §7 プラグイン契約（FR-F016～FR-F022）
- ARC-01 ディレクトリ構造・プラグインレジストリ（§4）
- ARC-02 データ分析プラグイン（構成の具体例）
- DATA-01 / DATA-02 型・スキーマ
