# 環境構築マニュアル（EXER）

## 1. 概要

本ドキュメントは、**必要なソフトウェアがまだインストールされていない**ことを前提に、EXER プロジェクトの開発環境をゼロから構築する手順を説明する。初心者が読んでわかるように、各ステップを詳細に記述する。

- **対象**: 開発者・Contributor
- **成果**: ローカルで開発サーバを起動し、画面にアクセスできる状態

---

## 2. 必要なソフトウェア

| ソフトウェア | 用途 | 推奨バージョン（目安） |
|--------------|------|------------------------|
| **Node.js** | フロントエンド・API の実行 | LTS（18.x または 20.x 以上） |
| **npm** | パッケージ管理（Node.js に同梱） | Node に同梱 |
| **Git** | リポジトリのクローン・履歴管理 | 2.x 以上 |
| **Python** | データ分析プラグインの採点（Pyodide はブラウザ内のため、開発マシンに Python は必須ではないが、スクリプト・シードデータ検証等で使う場合あり） | 3.11 以上（任意） |

---

## 3. Node.js のインストール

### 3.1 Windows

1. [Node.js 公式サイト](https://nodejs.org/) の LTS 版をダウンロードする。
2. インストーラを実行し、指示に従ってインストールする。「Add to PATH」にチェックを入れる。
3. コマンドプロンプトまたは PowerShell を**新しく開き**、次を実行して確認する。
   ```powershell
   node -v
   npm -v
   ```
   - バージョン番号が表示されれば OK。

### 3.2 macOS

- **Homebrew を使う場合**（推奨）:
  ```bash
  brew install node
  ```
- または [Node.js 公式サイト](https://nodejs.org/) から LTS 版のインストーラをダウンロードしてインストールする。

インストール後、ターミナルで `node -v` と `npm -v` で確認する。

### 3.3 注意

- 複数バージョンを切り替える場合は **nvm**（Node Version Manager）の利用を推奨する。手順は nvm の公式ドキュメントを参照。

---

## 4. Git のインストール

### 4.1 Windows

- [Git for Windows](https://git-scm.com/download/win) をダウンロードしてインストールする。
- インストール後、コマンドプロンプトまたは PowerShell で `git --version` で確認する。

### 4.2 macOS

- Xcode Command Line Tools を入れると Git が含まれる。
  ```bash
  xcode-select --install
  ```
- または `brew install git` でインストールする。

---

## 5. リポジトリのクローン

1. リポジトリの URL を用意する（例: `https://github.com/your-org/py-value.git` または SSH の `git@github.com:your-org/py-value.git`）。
2. クローン先のディレクトリに移動する（例: `cd C:\Projects` または `cd ~/Projects`）。
3. クローンを実行する。
   ```bash
   git clone <リポジトリURL>
   cd py-value
   ```
   - ディレクトリ名は実際のリポジトリ名に合わせる。

---

## 6. 依存パッケージのインストール

プロジェクトのルート（`py-value` など）で次を実行する。

```bash
npm install
```

または、CI と同一の依存で揃える場合:

```bash
npm ci
```

- `node_modules` が作成され、`package.json` の依存がインストールされる。初回は数分かかることがある。

---

## 7. 環境変数の設定

1. プロジェクト内の環境変数テンプレートをコピーする。
   - テンプレートの場所: `docs/01_specs/06_operations/env.example`
   - ルートに `.env` を作成し、テンプレートの内容をコピーする。
     ```bash
     # Windows (PowerShell)
     Copy-Item docs\01_specs\06_operations\env.example .env

     # macOS / Linux
     cp docs/01_specs/06_operations/env.example .env
     ```
2. `.env` を開き、値を編集する。
   - `DATA_SOURCE=lowdb` のまま（開発は Lowdb）。
   - `LOWDB_PATH` を実際に JSON を置くディレクトリに（例: `./data`）。
   - `ADMIN_KEY` をローカル用の任意の文字列に（管理画面の ?key=xxx に使う）。
3. **`.env` はリポジトリにコミットしない**（.gitignore に含まれていることを確認する）。

---

## 8. シードデータの準備（初回のみ）

開発環境で問題一覧を表示するには、ワークブックと問題のデータが必要である。

1. `docs/01_specs/06_operations/INFRA-01_operations_and_deploy.md` の「7. シードデータ」を参照する。
2. `DATA_SOURCE=lowdb` の場合、Lowdb 用の JSON ファイル（例: `data/workbooks.json`, `data/questions.json`）を配置する。
   - プロジェクトにシード用スクリプトやサンプル JSON が含まれていれば、その手順に従う。
   - 含まれていない場合は、DATA-01 / DATA-02 のスキーマに従い、手動で 1 ワークブック・数問の問題 JSON を用意する。

---

## 9. 開発サーバの起動

プロジェクトルートで次を実行する。

```bash
npm run dev
```

- Next.js の開発サーバが起動する。多くの場合、`http://localhost:3000` でアクセスできる（表示される URL を確認する）。
- ブラウザで該当 URL を開き、ホームや問題一覧が表示されれば環境構築は完了である。

**終了する場合**: ターミナルで `Ctrl+C` を押す。

---

## 10. 本番ビルドとローカルでの確認（任意）

本番同様のビルドで動作確認する場合:

```bash
npm run build
npm run start
```

- `http://localhost:3000` で本番モードの挙動を確認できる。

---

## 11. 本番デプロイ（概要）

本番環境へのデプロイ手順は、利用するプラットフォーム（Firebase Hosting / Vercel / Cloud Run 等）に依存する。**IAM 権限・サービス有効化・環境変数の詳細および「人間が実施する作業」と「Cursor が自動化できる作業」の区別**は、以下で詳述する。

- **デプロイマニュアル（詳細）**: `docs/02_manuals/02_デプロイマニュアル.md` — IAM・API 有効化・環境変数一覧・人間 vs 自動化の明示
- **運用・デプロイの仕様**: `docs/01_specs/06_operations/INFRA-01_operations_and_deploy.md`
- **環境変数・シークレット**: `.cursor/skills/infra-engineer/reference.md`

一般的な流れ:

1. **人間**: 本番用の環境変数・シークレットをプラットフォームの画面で設定する。必要な API を有効化し、IAM を付与する。
2. Firestore 等のデータソースを用意し、必要ならシードデータを投入する（認証は人間が用意）。
3. `npm run build` でビルドし、プラットフォームのデプロイコマンド（例: `firebase deploy`, `vercel --prod`）を実行する。

---

## 12. OS 別の注意

| OS | 注意点 |
|----|--------|
| **Windows** | パス区切りは `\`。スクリプト内では `/` も利用可能な場合が多い。PowerShell では `&&` が使えないため、複数コマンドは `;` でつなぐ。 |
| **macOS** | ターミナルは標準で bash または zsh。権限エラー時は `chmod` やインストール先の権限を確認する。 |
| **Linux** | パッケージマネージャ（apt / yum 等）で Node を入れる場合、バージョンが古いことがある。LTS が必要なら NodeSource や nvm を利用する。 |

---

## 13. トラブルシューティング

| 現象 | 対処の目安 |
|------|------------|
| `node: command not found` | Node.js が PATH に含まれていない。インストール先を確認し、ターミナルを開き直す。 |
| `npm install` で EACCES | グローバル領域の権限問題。プロジェクト内では `npm install` のみでよい。必要なら nvm でユーザー領域に Node を入れる。 |
| ポート 3000 が使用中 | 別の Next.js やアプリが使用している。プロセスを終了するか、`next dev -p 3001` のように別ポートを指定する。 |
| 画面が真っ白・API エラー | .env の `DATA_SOURCE` と `LOWDB_PATH`、およびシードデータの有無を確認する。 |

---

## 14. 参照

- 運用・デプロイ: `docs/01_specs/06_operations/INFRA-01_operations_and_deploy.md`
- シードデータ: `docs/01_specs/06_operations/seed/README.md`
- 仕様の正本: `docs/01_specs/`（01_specs README）
