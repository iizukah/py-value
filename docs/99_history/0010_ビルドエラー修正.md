# 0010 ビルドエラー修正

## 日付

2026-02-07

## 変更概要

最低限初回デプロイ実装（0009）後の `npm run build` 失敗を解消した。

### 1. JSX 構文エラー（src/app/[workbookId]/page.tsx）

- **事象**: `Unexpected token div. Expected jsx identifier`。`<Link>` を `</li>` で閉じており、その直後に重複した `</li>` があった。
- **対応**: `<Link>...</Link>` で正しく閉じ、`</li>` を 1 つにした。

### 2. Pyodide のクライアントバンドル（UnhandledSchemeError）

- **事象**: `import("pyodide")` により、Node 向けモジュール（node:child_process, node:fs, node:crypto 等）がクライアントバンドルに含まれ、webpack が `node:` URI を扱えずビルド失敗。
- **対応**: npm パッケージの import をやめ、**ブラウザで CDN から Pyodide を動的読み込み**するように変更（src/core/plugins/python-analysis/judge.ts）。初回実行時に `<script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js">` を差し込み、読み込み後に `globalThis.loadPyodide` でランタイムを取得。

### 3. 型エラー（judge.ts）

- **事象**: `pyodide.globals.get("ans")` の戻り値が `unknown` のため、`ans?.toJs` 参照で TypeScript エラー。
- **対応**: `(ans as { toJs?: () => unknown })` 等の型アサーションで解消。

### 4. .cursor ルールの拡張（99_history 報告）

- **対応**: `.cursor/rules/commits-and-history.mdc` の 99_history 節を拡張した。実装・バグ修正を行ったときも 99_history に報告することを明記。新規の事象なら新規ファイルを連番で作成、既存の関連事項なら該当ファイルに追記する運用とした。

## 関連ドキュメント

- 0009_最低限初回デプロイ実装.md
- src/app/[workbookId]/page.tsx
- src/core/plugins/python-analysis/judge.ts
- .cursor/rules/commits-and-history.mdc
