# 0037 ワークスペース 採点位置・ローディング・セル表示

## 日付

2025-02-08

## 概要

ワークスペースの左ペインで採点結果の表示位置を変更し、ローディングの垂直揃えを修正し、セル内コードの HTML 実体・マークアップ露出を防ぐ修正を行った。

## 変更内容

1. **採点結果の位置**
   - 左ペインの表示順を「CHALLENGE（問題タイトル・タグ）→ 問題文 → 採点結果」から「CHALLENGE → **採点結果** → 問題文」に変更。採点結果ブロックを tile-header の直後に移動した。

2. **ローディングの垂直揃え**
   - stats-loader のクラスを `items-end` から `items-center` に変更（3 箇所）。Pyodide 準備中オーバーレイ、採点中/実行中オーバーレイ、共通 LoadingOverlay。アニメーションと「準備中」「採点中」の文言が縦方向で一つのブロックとして揃うようにした。

3. **セル表示の不具合（&#39; と class="py-string" 等の露出）**
   - **python-highlight.ts**: `escapeHtml` からシングルクォート（`'` → `&#39;`）のエスケープを削除。HTML テキスト内では `'` はそのままでよく、シングルクォート文字列用正規表現が正しくマッチするようにした。
   - **decode-html-entities.ts**: `decodeHtmlEntities` を新規ユーティリティとして切り出し、CodeInputWithHighlight と index の両方から利用。
   - **index.tsx**: 初期セル（initialCells）、initialAnswer から setCells する useEffect、handleReset で、各セルの `content` に `decodeHtmlEntities` を適用してから state に渡すようにした。外部から取り込む値に HTML 実体が残らないようにする。

## 変更ファイル

- `src/core/plugins/python-analysis/index.tsx` — 採点結果ブロックの位置、stats-loader を items-center、decodeHtmlEntities の import と初期値・復元・リセット時のデコード
- `src/core/plugins/python-analysis/python-highlight.ts` — escapeHtml から `'` のエスケープを削除
- `src/core/plugins/python-analysis/CodeInputWithHighlight.tsx` — decodeHtmlEntities を decode-html-entities から import
- `src/core/plugins/python-analysis/decode-html-entities.ts` — 新規（decodeHtmlEntities）
- `src/app/components/layout/LoadingOverlay.tsx` — stats-loader を items-center に変更

## 関連ドキュメント

- .cursor/plans ワークスペース採点位置・ローディング・セル表示プラン
- CD-018, CD-019, CD-020
