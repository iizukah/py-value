# 0032 UI・ワークスペース・仕様整合修正（DD-012～DD-017）

## 日付

2025-02-07

## 変更内容

プラン「UI・ワークスペース・仕様整合修正」に従い、以下を実施した。

### タイポグラフィ・レイアウト

- **globals.css**: `.typography-title`、`.typography-heading` を追加。採点結果ブロックの `.result-medal-wrap` の min-height 削除、`.result-tile` の min-height 削除で余白を削減。
- **問題一覧**: h1 に typography-title 適用。タイル footer のアイコンはみ出しを解消（min-w-0, flex-wrap, ボタン shrink-0・padding 調整）。
- **ワークスペース**: 問題ページの枠外 h1 を削除。プラグイン内「コード」ラベルに typography-heading 適用。
- **お気に入り**: サブタイトル「{workbook.title} のお気に入り問題」を削除。h1 に typography-title。タイルを問題一覧と同様の構成にし、ヘッダー右に「解除」、footer に Draft（API-021 で hasDraft 取得）＋Try。
- **履歴・履歴詳細**: h1 に typography-title。履歴詳細にバッジ（合格/不合格）と問題文（全文）を追加（問題 GET で取得）。

### パンくず

- **buildBreadcrumbs**: `questions` の次に questionId がある場合、「問題」単体（href=/wb/questions）を items に追加しないよう変更。404 解消。
- **Breadcrumb.tsx**: 問題ページの最終セグメント表示を「問題: {title}」に変更。

### ワークスペース機能（DATA-02, FR-P003, INFRA-01）

- **標準出力・標準エラー**: `runCodeAndGetVariables` で sys.stdout/stderr を StringIO に差し替え、実行後に取得。セル直下に Jupyter 風で stdout（通常色）・stderr（エラー色）・error を表示。
- **Pyodide パッケージ**: getPyodide() で初回に loadPackage(['numpy','matplotlib','pandas','scipy','scikit-learn','statsmodels']) を実行し、runJudge / runCodeAndGetVariables で共通利用。
- **ローディング表示**: 初回（Pyodide＋パッケージ）およびセル Run 実行中に、中央ペインに stats-loader + 「実行中...」「採点中...」のオーバーレイを表示。セル Run 実行中は他セルの Run を無効化。
- **Matplotlib 投影（FR-P003）**: セル Run 後に plt.get_fignums() があれば savefig で base64 取得し、右ペイン「Result Plot」に表示。plt.show() 実行時のみ更新。

### 99_diff

- **0009**: DD-012（ローディング表示）～ DD-017（Matplotlib 投影）を追記。

## 対象ファイル

- src/app/globals.css
- src/lib/breadcrumb.ts
- src/app/components/layout/Breadcrumb.tsx
- src/app/[workbookId]/QuestionListClient.tsx
- src/app/[workbookId]/questions/[questionId]/page.tsx
- src/core/plugins/python-analysis/judge.ts
- src/core/plugins/python-analysis/index.tsx
- src/app/[workbookId]/favorites/page.tsx
- src/app/[workbookId]/favorites/FavoritesListClient.tsx
- src/app/[workbookId]/history/page.tsx
- src/app/[workbookId]/history/[historyId]/page.tsx
- src/app/[workbookId]/history/[historyId]/HistoryDetailClient.tsx
- docs/01_specs/99_diff/0009_仕様と実装_細部差分_DD.md

## 関連 ID

- DD-012～DD-017（0009）
- FR-P003（Matplotlib 投影）
- DATA-02 §4.2（標準出力・標準エラー、Matplotlib DOM 投影）
- INFRA-01（NumPy / matplotlib / pandas）

---

## 事後修正（構文エラー）

- **現象**: `src/core/plugins/python-analysis/index.tsx` でビルド時 `Unexpected token \`div\`. Expected jsx identifier`（L.204 付近）。
- **原因**: ローディングオーバーレイ追加時に、中央ペイン（`<div className="pane flex flex-col">`）の閉じタグが 1 つ不足していた。セル用の `cell-group-ws relative` とその子の `cell-group-ws flex` の 2 つだけ `</div>` しており、中央ペイン自体を閉じる `</div>` がなかった。
- **対応**: セル一覧を囲む 2 つの `</div>` の直後に、中央ペインを閉じる `</div>` を 1 行追加した。
