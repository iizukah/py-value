# 0020 未実装要件充足・全テスト実装完了

## 日付

2025-02-07

## 概要

「未実装要件とテスト充足プラン」に従い、FR-F009, F010, F025, F026, F027（一覧）、FR-F008（管理での履歴 N）を実装し、結合テスト TC-INT-01, 02, 04, 05 を追加。TC-E2E-06 を「完了画面へ」導線検証に拡張。実装と mock の差分を 99_diff 0006 に記録した。

## 変更内容

### Phase 0
- `docs/01_specs/99_diff/0006_実装とmock差分_WCAG仕様正本.md` を新規作成。画面 ID・CP 単位で実装根拠（仕様・WCAG）と reference/mock.html の対比・変更ポイントを記載。

### Phase 1（問題一覧）
- **FR-F025** タグ表示: 各問題カードに `q.tags` 表示、aria-label「タグ: …」。
- **FR-F026** タグフィルター: 使用中タグ一覧からタグごとのリンク（`?tags=foo`）、フォーカス・キーボード対応。
- **FR-F027** お気に入りボタン: 各カードに ON/OFF ボタン、API-019/020 呼び出し、favoriteCount・自分がお気に入り済みかを反映、aria-label。
- **FR-F009** バッジ: 合格/不合格/未挑戦を履歴 API（API-005）からクライアントで導出し、カードにバッジ表示。UX-04 トークン（色・グロー）を適用。
- `src/app/[workbookId]/QuestionListClient.tsx` 新規、`src/app/[workbookId]/page.tsx` を QuestionListClient 利用に変更。

### Phase 2（完了画面導線）
- **FR-F010** 採点結果（SC-003）で全問正解時のみ「完了画面へ」リンク（`/[workbookId]/complete`）を表示。判定はクライアントで API-005 と問題一覧を利用。
- `src/core/plugins/python-analysis/index.tsx` に showCompleteLink 状態・useEffect・リンクを追加。
- TC-E2E-06 を「全問正解時に SC-003 から SC-004 へ遷移」するシナリオに拡張（list-and-workspace.spec.ts）。

### Phase 3（結合テスト）
- **TC-INT-01** `src/tests/integration/flow-submit.test.ts`: GET questions → GET question → POST submit、JudgeResult 検証。
- **TC-INT-02** `src/tests/integration/api-draft.test.ts`: PUT draft → GET draft で同一 userAnswer が返ることを検証。
- **TC-INT-04** `src/tests/integration/api-favorites.test.ts`: POST favorite → GET favorites に含まれる、DELETE 後に含まれないことを検証。
- **TC-INT-05** `src/tests/integration/api-questions.test.ts`: GET questions?tags=統計 で該当問題のみ返ることを検証。data/questions.json に tags を追加。
- TEST-01 に TC-INT-06（Web Worker 経由 runJudge）は別フェーズで追加する旨を注釈。

### Phase 4（履歴件数 N）
- **FR-F008** WorkbookRepository に `update(id, data)` を追加（インターフェース・Lowdb・Firestore）。`PUT /api/admin/workbooks/[workbookId]?key=xxx` で `{ historyLimit: number }` を受け取り更新。
- 管理ダッシュボード（SC-007）に「履歴の最大件数」入力・保存ボタンを追加。GET/PUT は同一 route（`src/app/api/admin/workbooks/[workbookId]/route.ts`）で実装。

### Phase 5・6
- E2E: 管理ダッシュボードの待機条件を「表または問題がありません」表示に変更。お気に入り一覧テストで「問題一覧」表示を待ってからクリック。
- 単体・結合 86 テストがパスすることを確認。99_diff 0006 を最終更新。

## 関連ドキュメント・ID

- 99_diff 0006（実装と mock 差分）
- TEST-01（TC-INT-01, 02, 04, 05, TC-E2E-06）
- UX-01, UX-02, UX-04（SC-001, SC-003, SC-007）
- FR-F008, FR-F009, FR-F010, FR-F025, FR-F026, FR-F027

## 次フェーズ（アーキテクト明示）

- **TC-INT-06**: Web Worker 経由 runJudge の実装と結合テスト追加。
- データセット本番ストレージ、E2E CI 組み込み等は別チケットで検討。
