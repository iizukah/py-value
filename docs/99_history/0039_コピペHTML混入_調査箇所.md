# 0039 コピペ時 HTML 混入 — 調査すべき個所

## 現象

セルにコピペすると、テキストエリアにはプレーンテキストが入るが、その下の pre（ハイライト用）に `class="py-string"` 等の HTML がそのまま表示される。または両方に HTML が残る。

## 調べるべき個所（優先順）

### 1. 貼り付けが「自前の onPaste」を通っているか

**ファイル:** `src/core/plugins/python-analysis/CodeInputWithHighlight.tsx`  
**確認:** テキストエリアに `onPaste={handlePaste}` が付いているか。ブラウザによっては Ctrl+V や右クリック「貼り付け」で `paste` が発火しない場合がある。

**確認方法:** `handlePaste` の先頭に `console.log("paste", e.clipboardData.types, e.clipboardData.getData("text/plain")?.slice(0,80))` を一時追加し、貼り付け時にログが出るか見る。出ない場合は「貼り付け」が別経路（例: ブラウザのデフォルト）で挿入されている。

### 2. clipboardData の内容

**同上**  
**確認:** `getData("text/plain")` と `getData("text/html")` の実際の値。  
リッチなコピー元だと `text/plain` に HTML が入っている、または `text/html` のみで `text/plain` が空、ということがある。

**確認方法:** `handlePaste` 内で `console.log({ plain: e.clipboardData.getData("text/plain")?.slice(0,200), html: e.clipboardData.getData("text/html")?.slice(0,200) })` を出し、貼り付け直後に何が渡っているか確認。

### 3. stripHtmlToPlainText の通過有無と結果

**ファイル:** `src/core/plugins/python-analysis/CodeInputWithHighlight.tsx` の `stripHtmlToPlainText`  
**確認:** 貼り付け文字列や、既に state に入っている HTML 混入文字列を `stripHtmlToPlainText` に通した「前・後」の文字列。  
画像のような `class=class="py-string">"py-comment">` の断片が除去できているか。

**確認方法:** 一時的に `stripHtmlToPlainText` 内で `console.log("stripHtml in", s.slice(0,150), "out", t.slice(0,150))` を出し、除去結果を確認。

### 4. value に HTML が入る経路（onPaste 以外）

**ファイル:** `src/core/plugins/python-analysis/index.tsx`  
**確認:** セルの `value`（= `cell.content`）がどこで設定されるか。

- 初期: `initialCells` / `question.initial_code` / `initialAnswer?.cells` に `decodeHtmlEntities` はかかっているが、**HTML タグ除去はしていない**。
- ドラフト復元: `useEffect` で `initialAnswer?.cells` を `decodeHtmlEntities` して `setCells` しているが、**タグ除去はしていない**。
- 採点結果や Run 出力の表示は別コンポーネントなので、セル内容の混入経路としては考えにくい。

**結論:** コピペで入った HTML は「貼り付け → handlePaste → onChange(normalized)」で正規化される想定。  
もし **onPaste が動いていない** か **default の貼り付けが先に効いている** と、`value` に生の HTML が入り、表示時は `plainValue` で strip しているが、state の同期 useEffect が動く前に描画が走る、または同期が一度しか走らず残る、といった可能性がある。

### 5. 表示用 plainValue と state 同期のタイミング

**ファイル:** `CodeInputWithHighlight.tsx`  
**確認:**  
- `plainValue` は `value`（= `cell.content`）にタグが含まれるとき `stripHtmlToPlainText(decodedValue)` で算出している。  
- `useEffect` で `value` にタグがあるとき `onChange(normalized)` を呼び state を上書きしている。

**確認方法:**  
- 貼り付け直後の 1 フレームで、まだ `value` が HTML のままなのに pre には `highlightPython(plainValue)` が渡っているか（＝ plainValue が正しく strip 済みか）。  
- `useEffect` の依存は `[value, onChange]`。親が `onChange` で state を更新し、再レンダーで `value` が正規化済みになるまで、一瞬でも HTML の value で pre が描画されていないか。

### 6. ブラウザの「貼り付け」の挙動

**確認:**  
- 同じテキストエリアで、**右クリック → 貼り付け** と **Ctrl+V** の両方で `handlePaste` が呼ばれるか。  
- `e.preventDefault()` しているため、デフォルトの貼り付けは止まる想定。止まっていないと、`handlePaste` で挿入した正規化テキストのあとに、デフォルトで HTML がさらに挿入される可能性がある。

---

## コード側で行った強化（今回）

- `stripHtmlToPlainText` で以下を追加除去:
  - `"py-keyword">` / `"py-string">` / `"py-comment">` / `"py-number">` のような `"py-xxx">` の残骸
  - `class="py-string">` や `class=class="py-string">` のような `class=...>` の残骸

これでも残る場合は、上記 1〜6 を順に確認すると原因を切り分けやすい。

## 関連

- DD-022（セル入力・ハイライト）
- 0037 セル表示（decodeHtmlEntities）
- 0038 ローディングヒストグラム
