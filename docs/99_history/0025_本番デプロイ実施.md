# 0025 本番デプロイ実施（Phase 4 記録）

## 日付

2025-02-07（初版）、2026-02-08（本番デプロイ実施）

## 実施内容

本番デプロイまで残タスク消化プラン Phase 4 に基づき、以下を実施した。

1. **Cloud Run デプロイ**
   - 初回は `gcloud run deploy --source .` でビルドが失敗したため、**cloudbuild.yaml** を追加（E2_HIGHCPU_8・docker build → push → gcloud run deploy）。`.env` から `ADMIN_KEY` と `GOOGLE_CLOUD_PROJECT` を読み、`gcloud builds submit --config=cloudbuild.yaml --substitutions=_ADMIN_KEY=...,_GOOGLE_CLOUD_PROJECT=...` でビルド・デプロイを実行。
   - **2026-02-08**: 上記で Cloud Run へデプロイ成功。Service URL: **https://exer-next-85028816057.asia-northeast1.run.app**。ビルド時に TypeScript の `Set` イテレーションエラーが出たため、`src/app/[workbookId]/page.tsx` の `[...new Set(...)]` を `Array.from(new Set(...))` に修正。Dockerfile に `NODE_OPTIONS=--max-old-space-size=4096` を追加。デプロイ後、IAM で `allUsers` に `roles/run.invoker` を付与し未認証アクセスを許可。

2. **Firebase デプロイ**
   - `firebase use exir-27624` のうえで `firebase deploy --only "hosting,firestore"` を実行。Firestore ルール・インデックスと Hosting（全リクエストを Cloud Run に転送）をデプロイ済み。

3. **デプロイ先 URL**
   - **Firebase Hosting**: **https://exir-27624.web.app**（本番アプリの入口）
   - **Cloud Run 直**: https://exer-next-85028816057.asia-northeast1.run.app

## 実施者が行う手順（次回以降）

1. ルートの `.env` に `GOOGLE_CLOUD_PROJECT=<GCP プロジェクト ID>` と `ADMIN_KEY=<管理用キー>` を設定する。
2. PowerShell で上記の gcloud run deploy を実行（マニュアルまたはプラン記載のコマンドを参照）。
3. 続けて `firebase deploy --only "hosting,firestore"` を実行する。
4. デプロイ完了後、Firebase Hosting の URL で動作確認する。

## 関連ドキュメント

- INFRA-01
- docs/02_manuals/02_デプロイマニュアル.md
