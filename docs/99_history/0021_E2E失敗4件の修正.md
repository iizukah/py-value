# 0021 E2E 失敗 4 件の修正

## 日付

2025-02-07

## 概要

`npm run test:e2e` で失敗していた 4 件の E2E を修正した。原因と対応を記録する。

## 失敗と修正内容

| テスト | 原因 | 修正 |
|--------|------|------|
| **TC-E2E-09**（お気に入り一覧表示） | `getByText('問題一覧')` がヘッダリンクと本文の 2 要素にマッチし strict mode 違反 | `page.getByRole('main').getByText('問題一覧')` で main 内のみに限定。goto を `waitUntil: 'load'`, `timeout: 30000` に変更し安定化。 |
| **TC-E2E-12**（データセットアップロード） | ファイル input の `aria-label` が「CSV またはテキストファイルを選択」のため、`getByLabel('ファイルアップロード')` が一致しない | アサーションを `getByLabel('CSV またはテキストファイルを選択')` に変更（DatasetUploadClient の input の aria-label に合わせる）。 |
| **TC-E2E-10**（お気に入り→問題） | `waitForURL` が navigation の `load` 完了を 30s で待ち切れずタイムアウト | テスト timeout を 60s に延長。`waitForURL` をやめ `expect(page).toHaveURL(..., { timeout: 45000 })` に変更。 |
| **TC-E2E-06**（完了画面へ導線） | 「実行・採点」クリック時にコード未入力のため runJudge が失敗し "Passed" が出ない | クリック前に `page.getByRole('textbox').first().fill('ans = 1')` で正解コードを入力（q1 は expected_value: 1）。 |
| **TC-E2E-11**（編集リンク） | 編集リンククリック後の `waitForURL` が 30s でタイムアウト | `waitForURL` を `expect(page).toHaveURL(..., { timeout: 45000 })` に変更。 |

## 変更ファイル

- `src/tests/e2e/favorites.spec.ts`（TC-E2E-09, TC-E2E-10）
- `src/tests/e2e/admin.spec.ts`（TC-E2E-11, TC-E2E-12）
- `src/tests/e2e/list-and-workspace.spec.ts`（TC-E2E-06）

## 追記（TC-E2E-11 編集リンクで table が表示されない）

- **事象**: ダッシュボードで `getByRole('table').or(getByText('問題がありません'))` が 25s 以内に表示されずタイムアウト。
- **原因**: 問題一覧とワークブックの 2 リクエスト完了まで「読み込み中...」が表示され続け、表の待機だけでは読み込み完了を待てていなかった。
- **対応**: (1) 先に「読み込み中...」が消えるまで最大 35s 待機。(2) 「キーが無効です」が表示されたら `test.skip()`。(3) テスト timeout を 60s に延長。(4) その後に表または「問題がありません」を 10s で待機。

## 補足（TC-E2E-11 スキップ対策）

- **事象**: 管理キーが無効と判定され TC-E2E-11 がスキップされる。
- **原因**: サーバは `ADMIN_API_KEY` のみ参照していたが、.env や env.example では `ADMIN_KEY` を使用。E2E は `test-admin-key` を送るが、既存サーバは .env の `ADMIN_KEY` しか読んでおらず不一致になっていた。
- **対応**: (1) `admin-key.ts` で `ADMIN_API_KEY ?? ADMIN_KEY` の両方を参照するよう変更。(2) `playwright.config.ts` で .env を読み込み、test と webServer で同じキーを使うようにした。E2E では `process.env.ADMIN_API_KEY ?? process.env.ADMIN_KEY ?? "test-admin-key"` を使用。(3) .env に `ADMIN_KEY=test-admin-key` を設定するか、未設定のまま test:e2e のみ実行（webServer が test-admin-key を注入）すればスキップされない。env.example に注記を追加。

## 補足

- TC-E2E-09 の `net::ERR_ABORTED` は、dev サーバ未起動や再起動直後の不安定時に出ることがある。E2E 実行前に `npm run dev` でサーバを立ち上げ、安定してから `npm run test:e2e` を実行すること。
- 関連: TEST-01（TC-E2E-06, 09, 10, 11, 12）
