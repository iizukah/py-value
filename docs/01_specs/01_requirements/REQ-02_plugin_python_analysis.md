# REQ-02 データ分析問題集プラグイン 要件定義書（EXER 第一版）

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| **ID** | REQ-02 |
| **プロジェクト名** | EXER |
| **準拠表明** | 本プラグインは **REQ-01 のプラグイン契約に準拠**する。REQ-01 の契約が変更された場合は本ドキュメントを改訂する。タグ・お気に入り等の枠組み機能は REQ-01 に定義する。 |
| **スコープ** | 統計検定・データ分析問題に特化したプラグイン。表示用 React コンポーネントと判定アダプタ、問題データ構造、採点アルゴリズム。 |
| **関連ドキュメント** | REQ-01（枠組み・プラグイン契約）、後続の DATA-01, DATA-02, UX-02, UX-03 |

---

## 2. 目的・スコープ

- **目的**: 「統計検定の計算問題を、本物のコードで解く」ブラウザ完結型の学習体験を、枠組みの 1 プラグインとして提供する。
- **ターゲット**: 統計検定受験者、データサイエンス初学者、環境構築に制限がある企業内研修生。
- **スコープ**: 問題の type が本プラグイン用（例: `python-analysis`）である場合の表示・実行・採点を担当する。

---

## 3. 用語定義（REQ-01 と重複しない範囲）

| 用語 | 定義 |
|------|------|
| セル | Jupyter ライクなコード入力単位。複数セルがある場合、採点時は全セルのコードを結合して 1 つのスクリプトとして実行し、その結果を判定する。 |
| 変数監視 | 問題データで指定した変数名（例: ans, p_value）の現在値をサイドパネルに表示する。指定は問題データで固定とする。 |
| 仮想FS | Pyodide 内のファイルシステム。CSV 等のデータセットを配置し、コードから参照する。 |

---

## 4. 技術スタック

- **実行エンジン**: Pyodide (Python 3.11+ / WebAssembly)
- **コードエディタ**: Monaco Editor (VS Code Core)
- **主要ライブラリ**: Pandas, NumPy, Matplotlib, SciPy, Statsmodels, Scikit-learn
- **判定**: ブラウザ内（Web Worker + Pyodide）で完結する。枠組みが本プラグインの判定アダプタを呼び出す。

---

## 5. 機能要件

### 5.1 学習機能

- **FR-P001** Jupyter ライクなセル: セル間での状態保持、`Shift + Enter` で実行。複数セルがある場合は、**採点時に全セルのコードを結合して 1 つのスクリプトとして実行し、その結果を判定する**。
- **FR-P002** 統計学習支援: CSV 等を仮想 FS に配置し、コードから読み込めるようにする。本番では Firebase Storage、開発では静的ファイル（例: `public/data/`）を参照する。
- **FR-P003** Matplotlib 投影: 生成された図表を DOM に即時投影する。
- **FR-P004** 変数監視: 問題データで指定した変数（ans, p_value 等）をサイドパネルで表示する。指定は問題データで固定とする。
- **FR-P005** 実行制御: コード実行の中断（Interrupt）およびカーネルリセットを提供する。
- **FR-P006** 実行タイムアウト: 無限ループ等を防ぐため、実行時間の上限を 1 分（60 秒）とする。
- **FR-P007** 初期コードが空の場合: エディタは空の 1 セルで表示する。

### 5.2 採点アルゴリズム

- **FR-P008** 数値計算・統計検定: 原則として変数 `ans` の値を検証。浮動小数点誤差を考慮し、`math.isclose()` 等で判定（atol: 1e-5, rtol: 1e-3）。必要に応じて中間変数（p_value, std_error 等）もチェックする。
- **FR-P009** Matplotlib: Axes からプロットされた数値配列を抽出し、期待値との相関（r > 0.99）を確認。凡例・色・ラベル等の見た目は指定がない限り採点対象外とする。
- **FR-P010** 機械学習相対評価: 検証データに対する Accuracy 等をパーセンテージで表示。ベースライン比較を参考値として提示する。
- **FR-P011** エラー種別: 要件では種別のみ定義する（タイムアウト、実行エラー、採点エラー等）。文言は 04_ui_ux または実装に任せる。

---

## 6. 問題データ構造（データ分析プラグイン用）

REQ-01 の共通基底に加え、本プラグイン用の拡張として以下を採用する。矛盾がなければ既存のデータ分析問題用 JSON スキーマをそのまま採用する。

- **problem_statement**: 問題文（Markdown）
- **initial_code**: 初期コード。空の場合は空の 1 セルとする。
- **explanation**: 解説（Markdown）
- **dataset**: file_name, url（または path）でデータセットを参照する。
- **validation**: method（value_match | script | ml_test）, expected_value, tolerance, baseline_value, hidden_test_script, hint 等。
- **metadata**: status（draft | published）, created_at 等。
- 変数監視する変数名は問題データで指定する（例: 変数名の配列または validation 内で定義）。

（厳密な JSON Schema は DATA-01 に委ねる。）

---

## 7. UI/UX

- **レイアウト**: 3 ペイン（問題 / エディタ / 可視化・ステータス・変数監視）。詳細は UX-03 を参照。
- **テーマ・トークン**: UX-02 §3、UX-04 デザイン仕様を参照する。色・余白・角丸等の具体値はそちらで定義する。
- **フィードバック**: ローディング表示、正解時のバッジ等。バッジは枠組みと連携し、問題一覧の各カードに表示する（REQ-01 FR-F009）。

---

## 8. ユースケース一覧（プラグイン）

| ID | ユースケース名 | 概要 |
|----|----------------|------|
| UC-P01 | 統計問題を閲覧する | 問題文とデータ構造を 3 ペインの「問題ペイン」で確認する。 |
| UC-P02 | Python コードを実行する | Monaco Editor で記述したコードを WASM 上で実行し、結果を確認する。Shift + Enter でトリガー。 |
| UC-P03 | グラフ・可視化を確認する | Matplotlib 等で生成された図表を DOM 上で確認する。 |
| UC-P04 | 変数をトラッキングする | 問題データで指定した変数（ans, p_value 等）の現在値をサイドパネルで監視する。 |
| UC-P05 | 自動採点を実行する | 記述したコードの出力が判定ロジックを満たすか確認する。全セルを結合して実行した結果で判定する。 |
| UC-P06 | 学習フィードバックを受け取る | 採点結果に応じたバッジや、機械学習のベースライン比較を確認する。 |
| UC-P07 | （管理）問題を登録・管理する | 管理者がデータ分析問題用の項目（初期コード、採点ロジック、データセット参照、変数監視対象）を登録・編集する。枠の UC-F07 の具体。 |
| UC-P08 | （管理）データのインポート/エクスポート | データ分析問題の JSON 一括入出力。枠の UC-F08 の具体。 |

---

## 9. 画面・コンポーネント

- **ワークスペース**: 問題ペイン（左）、エディタ・セル領域（中央）、可視化・変数パネル（右）の 3 ペイン構成。
- **変数パネル**: 問題データで指定された変数名とその現在値を表示する。
- **プロット領域**: Matplotlib の出力を表示する。

（コンポーネント ID や詳細は 04_ui_ux で定義する。）

---

## 10. 非機能要件・制約

- **NFR-P001** WASM: Pyodide のロード失敗時は、エラー表示のみとし、ワークスペースの操作は行えない。問題文のみ読める状態は MVP では用意しない。
- **NFR-P002** サンドボックス: コード実行は WASM/Web Worker 内で完結し、セキュリティを担保する。

---

## 11. ロードマップ（プラグイン）

- **Phase 2**: Markdown 対応セルの実装（MVP 外）。
- **Phase 3**: コードの自動保存（localStorage 等）（MVP 外）。
- **Phase 4**: 複数チャプター管理との連携（MVP 外）。

---

## 12. MVP スコープ（プラグイン）

**含める**: セル実行（Shift + Enter）、全セル結合による採点、仮想 FS・データ配備、Matplotlib 投影、変数監視（問題データで固定指定）、実行中断・カーネルリセット、実行タイムアウト 1 分、数値近傍・Matplotlib・ML 相対評価の採点、初期コード空のときは空の 1 セル。

**含めない**: Markdown セル、コードの自動保存、複数チャプター。エラーメッセージの文言は要件では種別のみとし、文言は 04_ui_ux/実装に任せる。

---

## 13. トレーサビリティ（本ドキュメントで定義する ID と他ドキュメントの対応）

| 本ドキュメント | 対応する REQ-01 | 対応する UX | 対応する DATA |
|----------------|-----------------|-------------|---------------|
| FR-P001～FR-P011 | FR-F002, FR-F007, FR-F018～F019 | UX-03（SC-002 内）、UX-02 CP-009 | DATA-02 |
| UC-P01～UC-P06 | UC-F02, UC-F05 | UX-03（問題ペイン・エディタ・変数パネル） | DATA-02 |
| UC-P07, UC-P08 | UC-F07, UC-F08 | UX-01 SC-008, SC-009 | DATA-02 |
