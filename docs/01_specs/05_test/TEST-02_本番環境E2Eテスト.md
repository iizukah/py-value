# TEST-02 本番環境 E2E テスト（EXER 第一版）

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| **ID** | TEST-02 |
| **プロジェクト名** | EXER |
| **関連ドキュメント** | TEST-01（テスト計画書）, INFRA-01（運用・デプロイ） |

本ドキュメントは、**本番環境**（https://exir-27624.web.app/）に対する Playwright E2E テストの対象・実行条件・手順・報告を定義する。TEST-01 で定義した E2E ケース（TC-E2E-01 ～ TC-E2E-13）を本番 URL に対して実行し、デプロイ後のサイトが要件を満たすことを確認する。

---

## 2. 対象環境

| 項目 | 内容 |
|------|------|
| **本番 URL** | https://exir-27624.web.app/ |
| **構成** | Firebase Hosting → Cloud Run（exer-next）。同一オリジンで `/api/*` も提供される。 |
| **実行形態** | ローカルマシンから Playwright を実行する。CI/CD（GitHub Actions 等）は本仕様の対象外とする。 |

---

## 3. 目的とテストケース対応

- **目的**: デプロイ後の本番サイトが、TEST-01 §5 で定義した E2E テストケース（TC-E2E-01 ～ TC-E2E-13）を満たすことを確認する。
- **実行するテスト**: 既存の `src/tests/e2e/` 配下の全スペック（home, list-and-workspace, history, favorites, admin, keyboard）を、baseURL を本番 URL に設定したうえでそのまま実行する。

| テストケース ID | 概要（TEST-01 より） |
|-----------------|----------------------|
| TC-E2E-01 | ルートでホーム表示（ファーストビュー・問題集カード） |
| TC-E2E-02 | 問題集選択で一覧へ遷移 |
| TC-E2E-03 | 問題一覧でソート・タグフィルター・カード選択 |
| TC-E2E-04 | 問題選択でワークスペースへ遷移 |
| TC-E2E-05 | 解答送信後、採点結果表示 |
| TC-E2E-06 | 全問正解で完了画面へ遷移（※1） |
| TC-E2E-07 | 一覧へ戻る |
| TC-E2E-08 | 履歴一覧・詳細 |
| TC-E2E-09 | お気に入り一覧 |
| TC-E2E-10 | お気に入りから問題に挑戦 |
| TC-E2E-11 | 管理ダッシュボード → 問題登録エディタ |
| TC-E2E-12 | インポート/エクスポート・データセット導線 |
| TC-E2E-13 | キーボード操作（NFR-F004） |

※1 TC-E2E-06 の「全問正解時は採点結果から完了画面へ」は、実装で `page.route()` により API をモックしている。本番実行時もこのモックは本番オリジンへのリクエストをインターセプトするため、本番 API を実際に全問正解状態で叩くわけではないが、画面遷移と「完了画面へ」の導線は検証される。

---

## 4. 実行条件

### 4.1 環境変数

- **BASE_URL**: 本番 E2E 実行時に **本番 URL** を指定する。設定すると Playwright の baseURL に使われ、webServer は起動しない。
  - 例: `BASE_URL=https://exir-27624.web.app`
- **ADMIN_KEY** または **ADMIN_API_KEY**: 管理画面を含むテスト（TC-E2E-11, TC-E2E-12）を実行する場合、本番で有効な管理キーを設定する。
  - **重要**: 本番用キーは **.env にのみ記載し、リポジトリにコミットしない**。INFRA-01 および .env.example の扱いに従う。
  - .env は `playwright.config.ts` で読み込まれるため、実行前に .env に設定すればよい。

### 4.2 データ変更について

本番でフル E2E を実行するため、以下の操作により **本番データが変更され得る** ことを前提とする。

- お気に入りの追加・解除
- 解答送信による履歴の保存
- 管理画面での問題の作成・編集・削除、インポート/エクスポート、データセットアップロード

運用方針に応じて、本番実行の頻度や実行後のデータ確認を行うこと。

### 4.3 前提条件

- 本番サイトに **少なくとも 1 問以上** の公開問題が存在すること（問題一覧・ワークスペース・採点結果のテストで使用する）。
- ネットワーク遅延によりタイムアウトする場合は、TEST-01 や各 spec の `test.setTimeout` を必要に応じて延長する。

---

## 5. 実行手順

### 5.1 前準備

1. 依存関係をインストール済みであること（`npm ci` または `npm install`）。
2. 管理画面テストを実行する場合: `.env` に本番用の `ADMIN_KEY`（または `ADMIN_API_KEY`）を設定する。
3. （任意）Playwright ブラウザのインストール: `npx playwright install chromium`

### 5.2 実行コマンド

**本番 E2E 専用スクリプト（推奨）:**

```bash
npm run test:e2e:prod
```

**環境変数を明示して実行する場合:**

- **Windows（PowerShell）:**
  ```powershell
  $env:BASE_URL="https://exir-27624.web.app"; npx playwright test
  ```
- **Linux / macOS:**
  ```bash
  BASE_URL=https://exir-27624.web.app npx playwright test
  ```

`BASE_URL` を設定しないで `npx playwright test` を実行した場合は、従来どおりローカル（http://localhost:3000）で webServer が起動し、ローカル向け E2E が実行される。

### 5.3 レポートの確認

- 実行後、HTML レポートが生成される。表示するには:
  ```bash
  npx playwright show-report
  ```
- レポートの出力先は Playwright の設定（通常は `playwright-report/`）に従う。

---

## 6. 報告

本番 E2E 実行後は、以下の手順で報告する。

1. **報告書の作成**: `docs/99_history/` に、**連番** の新規ファイルを作成する（例: `0028_本番環境E2Eテスト実施報告.md`）。連番は既存の 99_history の最大番号の次とする。
2. **記載内容**:
   - 実施日付
   - 実施内容（本番 E2E の実行、対象 URL、実行コマンド）
   - 結果の要約（成功／失敗、失敗時は要因の簡潔な記述）
   - 関連ドキュメント ID（TEST-01, TEST-02）
3. **コミット**: 報告書および本仕様書・設定変更がある場合は、ルールに従い `git commit -F .git_commit_msg.txt` でコミットする。コミットメッセージには TEST-02 等の ID を含める。

---

## 7. 参照

- TEST-01 テスト計画書（E2E テストケース ID と UC/画面の対応）
- INFRA-01 運用・デプロイ・環境（本番環境変数・ADMIN_KEY の扱い）
- playwright.config.ts（BASE_URL と webServer の条件分岐）
