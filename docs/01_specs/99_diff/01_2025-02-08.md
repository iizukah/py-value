# 99_diff 統合（仕様と実装の差分・変更管理）

## 目的・日付

- **目的**: 既存 99_diff（0001～0009）を 1 ファイルに統合し、ID を整理。追加仕様・変更仕様・削除を明示し、仕様書・実装との対応を追跡可能にする。
- **日付**: 2025-02-08
- **統合元**: 0001_wireframe_ui_changes, 0002_採点結果画面_未対応TODO, 0003_mock_spec_incorporation, 0004_stage2_specs_consistency_check, 0005_レビュー指摘_修正差分, 0006_実装とmock差分_WCAG仕様正本, 0007_実装とmock差分_デザイン, 0008_Webデザイン変更一覧_CD, 0009_仕様と実装_細部差分_DD

---

## 1. 枠組み関連の差分（要件・画面・コンポーネント・CD）

### 1.1 ワイヤーフレーム／仕様書との差分（変更仕様）

| 項目 | 現行仕様書 | 変更内容 | 反映先・ID |
|------|------------|----------|------------|
| 問題一覧レイアウト | カード縦並び | タイル配置（flex/grid）、問題文冒頭抜粋、バッジ中央 | UX-01 SC-001, UX-02 CP-003, CP-004 |
| 正解・完了画面 | 特になし | 正解・完了ブロックを画面中央にレイアウト | UX-01 SC-003, SC-004, CP-009, CP-010 |
| 正誤表記 | 「正解」「不正解」 | **「合格」「不合格」**に統一。採点結果は **Passed/Fail** | UX-01 SC-005, SC-006, UX-02 CP-005, CP-006, CP-009, DATA-01 用語 |
| ヘッダ | 記載簡易 | ロゴ・ナビ（問題一覧・お気に入り・履歴・管理）を具体化 | UX-02 CP-001 |
| 管理ダッシュボード | 削除の対象・操作が不明 | 操作列に「編集」「削除」を並べる | UX-01 SC-007, REQ-01 FR-F07 |

### 1.2 採点結果画面（SC-003）未対応 To-Do（今後の改善・MVP 許容）

| No. | 内容 | 方針 |
|-----|------|------|
| 1 | タイル幅を画面の約 50% にする | 0002 に基づき「今後の改善事項」。MVP では現状の表示を許容。 |
| 2 | Retry ボタンをタイルの右下端に配置する | 同上。 |

### 1.3 mock 仕様組み込み（0003 実施済み）

- 04_ui_ux/reference に mock.html を配置。UX-01, UX-02 を mock 正で修正済み。0002 の未対応 To-Do は UX-01 SC-003 に「今後の改善」として言及済み。
- UX-03: 枠組みの UX-04 デザイントークン（CSS 変数）の参照は可能。具体的な色・余白のハードコードは避ける。

### 1.4 レビュー指摘に基づく修正差分（0005）

- **REQ-01 / DATA-01**: FR-F027 と UC-F12 の関係を整理。MVP ではモデル B（1 ユーザー 1 問題あたり 1 ドキュメントで count 保持、追加 +1・解除 -1）を採用と明記。
- **API-01**: 動詞 URI をリソース指向へ再考案（修正案節に記載）。管理系 API は MVP で簡易キー認証に留める旨を追記。
- **UX-01 / UX-02 / wireframes.html**: 合格・不合格／Passed/Fail 統一、SC-001 下部「履歴へ」削除、ヘッダにお気に入り追加、ソートにお気に入り数追加、SC-003 の今後の改善事項を記載。
- **REQ-02 NFR-P001 / ARC**: Pyodide ロード失敗時のフォールバックを具体化。TEST-01 に MVP 範囲（管理・履歴は導線確認に留める）を明記。

### 1.5 デザイン変更一覧（CD-001～CD-029）

- **正本**: docs/01_specs/04_ui_ux/reference/mock.html。変更管理 ID は CD-001～CD-029。
- 一覧は 0008_Webデザイン変更一覧_CD.md を参照。対象: ヘッダ（CD-001～003）、パンくず（CD-004）、ホーム（CD-005～008）、問題一覧（CD-009～015）、ワークスペース（CD-016～020）、採点結果・完了・履歴・お気に入り・管理・ローディング・フッター（CD-021～029）。

### 1.6 実装と mock 差分（WCAG・デザイン構造）

- **正本**: 実装は WCAG 2.1 および docs/01_specs を正とする。矛盾時は WCAG 優先。
- 画面・コンポーネント別の実装根拠と mock 差分は 0006, 0007 を参照。クラス名・構造の差分は後工程で mock に寄せる際の入力とする。

---

## 2. プラグイン関連の差分（要件・DD・CD）

### 2.1 細部差分（DD-001～DD-033）

| ID | 項目（概要） | 仕様上の扱い | 現行実装 | 方針 |
|----|--------------|--------------|----------|------|
| DD-001 | パンくずのレイアウト中央寄せ | mock .main-content で幅制限 | 左寄せ | .breadcrumb に max-width + margin: 0 auto |
| DD-002 | パンくず項目へのアイコン付与 | mock では区切りのみ | ホーム・ワークブックにアイコンあり | お気に入り→Heart、履歴→History、問題→FileCode 等 |
| DD-003 | 履歴一覧に問題タイトルを表示 | API-005 は questionId のみ | 「問題 {questionId}」表示 | クライアントで questionId→title マップで表示 |
| DD-004 | 履歴一覧 td 内の位置 | — | 左に詰まりすぎ | テーブル中央寄せ・td の padding で調整 |
| DD-005 | パンくずのラベルを ID からタイトルに | — | questionId/historyId 表示 | 最終セグメントをタイトルに差し替え |
| DD-006 | ワークスペース Retry 挙動 | 仕様に明示なし | 採点結果ブロック内に Retry | 結果ブロックから Retry 削除。ツールバーを「Retry」にし押下で状態リセット |
| DD-007 | 下書き保存のフィードバック | API-008 は契約のみ | 保存成功時フィードバックなし | 保存成功時に brief 表示（例: 「保存しました」） |
| DD-008 | 下書きの導線（問題一覧に Draft） | 仕様に明示なし | 問題一覧に Draft 導線なし | タイルに「Draft」。押下でワークスペースへ |
| DD-009 | 下書き一覧 API | API-01 に未定義 | GET draft は 1 問題 1 件のみ | API-021: GET /api/workbooks/{workbookId}/drafts で下書きあり questionId 一覧 |
| DD-010 | ワークスペース複数セル・Run/追加/削除 | mock cell-group-ws, cell-actions | 複数セル・セル単位 Run 実装済み | セル単位 Run で実行結果を Variable Watcher とセル下に表示。userAnswer は { cells: [...] } |
| DD-011 | 管理画面保存成功メッセージ | — | 保存後メッセージしてからリダイレクト | 成功時は即リダイレクト |
| DD-012 | ワークスペース ローディング表示 | 仕様にデザイン詳細なし | 初回・セル Run 時にオーバーレイ | stats-loader + メッセージを中央ペインに表示 |
| DD-013 | パンくず「問題」404・表示形式 | 仕様に明示なし | 「問題」href が 404 | 問題ページ最終項目を「問題: {title}」で表示 |
| DD-014 | ページタイトル typography | mock .typography-title | 各 h1 は font-bold のみ | 問題一覧・お気に入り・履歴の h1 に typography-title 適用 |
| DD-015 | セル下を stdout/stderr 表示 | DATA-02 §4.2 | セル下に変数一覧 | runCodeAndGetVariables で stdout/stderr をセル直下に Jupyter 風表示 |
| DD-016 | Pyodide パッケージ導入 | INFRA-01, DATA-02 | 導入済み | numpy, matplotlib, pandas, scipy, scikit-learn, statsmodels |
| DD-017 | Matplotlib DOM 投影（FR-P003） | REQ-02 FR-P003 | 実装済み | plt.show() 時に get_fignums から savefig base64 を右ペイン Result Plot に表示 |
| DD-018 | 問題一覧「ステータスでフィルター」 | 仕様に明示なし | フィルターあり／なし | 全て／未挑戦／未合格／合格。URL status= でクライアントフィルタ |
| DD-019 | 問題一覧「難易度でフィルター」 | 仕様に明示なし | 同上 | 全て／初級／中級／上級。URL difficulty= でクライアントフィルタ |
| DD-020 | ソート／フィルター折りたたみ | 仕様に明示なし | 常時表示 | 折りたたみ可能、デフォルト折りたたみ |
| DD-021 | 採点結果時の問題一覧 | 仕様に明示なし | 実装済み | 採点結果表示時に問題一覧をランダム最大10問。中央ペインに表示。Retry で非表示 |
| DD-022 | ワークスペース Python コードハイライト | 仕様に明示なし | 実装済み（Monaco） | Python シンタックスハイライト（Monaco Editor） |
| DD-023 | ワークスペース遷移時の全画面ローディング | 仕様に明示なし | 実装済み | Pyodide を mount 時にプリロードし、完了まで全画面オーバーレイ |
| DD-024 | 中央ペイン「コード」ラベル削除 | 仕様に明示なし | 削除済み | 中央ペインの「コード」ラベルを削除 |
| DD-025 | 入力コードの文字色 | 仕様に明示なし | 背景と同化する場合あり | ハイライト側のデフォルト色を var(--color-text) で明示 |
| DD-026 | 採点結果時の問題一覧を中央ペインに表示 | DD-021 で左ペイン案 | 実装済み（中央ペイン） | displayResult 時は中央ペインで問題一覧。左ペインから問題一覧ブロック削除 |
| DD-027 | 問題一覧の内容（CHALLENGE・難易度・タグ・問題文） | DD-021 でタイトルのみ | 10 問を個別 GET で order/difficulty/tags/problem_statement 取得 | 問題一覧画面と同様に表示 |
| DD-028 | Retry の隣にお気に入り | 仕様に明示なし | 実装済み | 採点結果表示時、ツールバーに Retry の隣でお気に入りアイコン |
| DD-029 | セルスクロールバー | 仕様に明示なし | デフォルト | scrollbar-color / ::-webkit-scrollbar をサイトトーンに合わせる（DD-043 等で実施） |
| DD-030 | コピペ時の表示ずれ | 仕様に明示なし | \r\n でずれる場合あり | onPaste で \r\n→\n に正規化 |
| DD-031 | リセットボタン | 仕様に明示なし | 実装済み | 「下書き保存」の左にリセット。押下で cells を initial_code の 1 セルに、採点・変数・プロットをクリア |
| DD-032 | 採点結果時中央ペイン見出し | 仕様に明示なし | 「問題一覧」 | 「次の問題に挑戦！」に変更（0036 で実施） |
| DD-033 | 問題文の Markdown・数式表示 | 仕様に明示なし | 実装済み | 問題文を GFM + LaTeX + HTML（rehype-raw + rehype-sanitize）で表示（0036 で実施） |

### 2.2 DRAFT 関連（追加仕様）

- **要件**: FR-F030 以降（REQ-01 に追記する場合）。下書き一覧取得・問題一覧からの下書き導線。
- **API**: API-021 GET /api/workbooks/{workbookId}/drafts
- **テスト**: TEST-01 に DRAFT 用セクションを追記。

---

## 3. ID 対応表

### 3.1 枠組み（REQ-01）

| 要件 ID | 内容 | 備考 |
|---------|------|------|
| FR-F001～FR-F028 | 既存定義のまま | 0005 で FR-F027 と UC-F12 の関係を整理済み |
| FR-F030 以降 | 下書き一覧・導線（追加用） | 追加仕様として REQ-01 に追記する場合 |

### 3.2 プラグイン（REQ-02）

| 要件 ID | 内容 | 備考 |
|---------|------|------|
| FR-P001～FR-P011 | 既存定義のまま | セル結合・変数監視・Matplotlib・実行制御・採点アルゴリズム |
| NFR-P001 | Pyodide ロード失敗時のフォールバック | 0005 で具体化 |

### 3.3 変更管理 ID

| 種別 | 範囲 | 備考 |
|------|------|------|
| CD | CD-001～CD-029 | デザイン変更一覧（0008）。mock 準拠の見た目変更 |
| DD | DD-001～DD-033 | 細部差分（0009）。仕様未記載・実装で補完した項目 |

### 3.4 API

| API ID | 内容 | 備考 |
|--------|------|------|
| API-001～API-020 | 既存定義 | 0005 で管理系 MVP 補足・URI 再考案案を記載 |
| API-021 | GET /api/workbooks/{workbookId}/drafts | 追加仕様（DD-009） |

---

## 4. 関連ドキュメント

- **要件**: REQ-01_platform_framework.md, REQ-02_plugin_python_analysis.md
- **アーキテクチャ**: ARC-01_system_design.md, ARC-02_plugin_python_analysis.md
- **契約**: DATA-01, DATA-02, API-01_rest_contract.md, API-02（plugins）
- **UI/UX**: UX-01_screens.md, UX-02_components.md, UX-03_plugin_python_analysis.md, UX-04_design_tokens.md, reference/mock.html
- **テスト**: TEST-01_test_plan.md, TEST-02_本番環境E2Eテスト.md
- **運用**: INFRA-01_operations_and_deploy.md
- **アーカイブ**: 統合前の 0001～0009 は docs/.drafts/archive に移動済み。
